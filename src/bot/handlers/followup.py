"""–ê–≤—Ç–æ-—Å–µ—Ä–∏—è follow-up: –ø—Ä–æ–≥—Ä–µ–≤ —á–µ—Ä–µ–∑ –ø–æ–ª–µ–∑–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç.

–ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∏–∫—Ä–æ—Ü–µ–Ω–Ω–æ—Å—Ç—å, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ ¬´–Ω–∞–ø–æ–º–∏–Ω–∞–ª–∫—É¬ª:

- Step 1 (24—á): —á–µ–∫-–ª–∏—Å—Ç / –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –ø–æ —Ç–µ–º–µ –≥–∞–π–¥–∞.
- Step 2 (3 –¥–Ω—è): —Ä–∞–∑–±–æ—Ä –∫–µ–π—Å–∞ –∏–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏ SOLIS Partners.
- Step 3 (7 –¥–Ω–µ–π): –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é + –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ç–µ–º—É.

–¢–µ–∫—Å—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ Google Sheets (–ª–∏—Å—Ç ¬´–ê–≤—Ç–æ-—Å–µ—Ä–∏—è¬ª).
–ï—Å–ª–∏ –ª–∏—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî fallback-—à–∞–±–ª–æ–Ω—ã —Å AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π.
"""

import logging

from aiogram import Bot
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup

from src.bot.utils.cache import TTLCache
from src.bot.utils.google_sheets import GoogleSheetsClient

logger = logging.getLogger(__name__)

# ‚îÄ‚îÄ –ú–∞–ø–ø–∏–Ω–≥ guide_id -> —Ç–µ–º–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

_GUIDE_TOPICS: dict[str, str] = {
    "too": "—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¢–û–û –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ",
    "ip": "–æ—Ç–∫—Ä—ã—Ç–∏–µ –ò–ü –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ",
    "mfca": "—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ –≤ –ú–§–¶–ê (AIFC)",
    "esop": "–æ–ø—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã ESOP –¥–ª—è —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤",
    "taxes": "–Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏–µ –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ",
    "labor": "—Ç—Ä—É–¥–æ–≤–æ–µ –ø—Ä–∞–≤–æ –∏ –Ω–∞–π–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",
    "it_law": "IT-–ø—Ä–∞–≤–æ –∏ –∑–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö",
    "ma": "—Å–¥–µ–ª–∫–∏ M&A –∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–æ",
}

# ‚îÄ‚îÄ –ß–µ–∫-–ª–∏—Å—Ç—ã –ø–æ —Ç–µ–º–µ –≥–∞–π–¥–∞ (Step 1 ‚Äî 24—á) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

_CHECKLISTS: dict[str, str] = {
    "too": (
        "üìã <b>5 –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¢–û–û</b>\n\n"
        "1. –í—ã–±–æ—Ä –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è ‚Äî "
        "–ø–µ—Ä–µ–ø–ª–∞—Ç–∞ –¥–æ 30% –Ω–∞–ª–æ–≥–æ–≤\n"
        "2. –£—Å—Ç–∞–≤–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª –Ω–∏–∂–µ –º–∏–Ω–∏–º—É–º–∞ –¥–ª—è –ª–∏—Ü–µ–Ω–∑–∏–π\n"
        "3. –û–¥–∏–Ω —É—á—Ä–µ–¥–∏—Ç–µ–ª—å –±–µ–∑ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è\n"
        "4. –ù–µ—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –∞–¥—Ä–µ—Å–∞ –¥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏\n"
        "5. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –û–ö–≠–î ‚Äî –ø—Ä–æ–±–ª–µ–º—ã —Å –±–∞–Ω–∫–æ–º\n\n"
        "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ–±—è ‚Äî –µ—Å–ª–∏ –Ω–∞—à–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –æ—à–∏–±–∫—É, "
        "–º—ã –ø–æ–º–æ–∂–µ–º –∏—Å–ø—Ä–∞–≤–∏—Ç—å."
    ),
    "ip": (
        "üìã <b>5 –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ò–ü</b>\n\n"
        "1. –í—ã–±–æ—Ä —É–ø—Ä–æ—â—ë–Ω–∫–∏, –∫–æ–≥–¥–∞ –≤—ã–≥–æ–¥–Ω–µ–µ –ø–∞—Ç–µ–Ω—Ç\n"
        "2. –ù–µ—Ç —Ä–∞–∑–¥–µ–ª—å–Ω–æ–≥–æ —É—á—ë—Ç–∞ –ª–∏—á–Ω—ã—Ö –∏ –±–∏–∑–Ω–µ—Å-—Å—Ä–µ–¥—Å—Ç–≤\n"
        "3. –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –±–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –¢–û–û\n"
        "4. –ù–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ (–Ω–∞–ª–æ–≥–æ–≤—ã–π —Ä–∏—Å–∫)\n"
        "5. –ü—Ä–æ–ø—É—Å–∫ —Å—Ä–æ–∫–∞ —Å–¥–∞—á–∏ 910-–π —Ñ–æ—Ä–º—ã\n\n"
        "–ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Å–≤–æ—é –æ—à–∏–±–∫—É ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ, –ø–æ–º–æ–∂–µ–º."
    ),
    "mfca": (
        "üìã <b>5 –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –ú–§–¶–ê</b>\n\n"
        "1. –ù–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–π –≤–∏–¥ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è AIFC\n"
        "2. –ù–µ–¥–æ–æ—Ü–µ–Ω–∫–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ substance\n"
        "3. –ù–µ—Ç –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω–∞ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º\n"
        "4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (holdco vs opco)\n"
        "5. –ü—Ä–æ–ø—É—Å–∫ –¥–µ–¥–ª–∞–π–Ω–∞ annual return\n\n"
        "–ú–§–¶–ê ‚Äî –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –Ω–æ —Å –Ω—é–∞–Ω—Å–∞–º–∏."
    ),
    "taxes": (
        "üìã <b>5 –Ω–∞–ª–æ–≥–æ–≤—ã—Ö –æ—à–∏–±–æ–∫ –±–∏–∑–Ω–µ—Å–∞ –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ</b>\n\n"
        "1. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ª—å–≥–æ—Ç—É –°–≠–ó –∏–ª–∏ –ú–§–¶–ê\n"
        "2. –ù–µ—Ç —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—Ç–Ω–æ–≥–æ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏)\n"
        "3. –ù–î–° –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ IT-—É—Å–ª—É–≥ (–º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å)\n"
        "4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç –ò–ü–ù —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤\n"
        "5. –ù–µ—Ç –Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –≥–æ–¥ –≤–ø–µ—Ä—ë–¥\n\n"
        "–ö–∞–∂–¥–∞—è –∏–∑ —ç—Ç–∏—Ö –æ—à–∏–±–æ–∫ —Å—Ç–æ–∏—Ç –±–∏–∑–Ω–µ—Å—É –æ—Ç 500 —Ç—ã—Å. —Ç–µ–Ω–≥–µ."
    ),
    "labor": (
        "üìã <b>5 –æ—à–∏–±–æ–∫ –≤ —Ç—Ä—É–¥–æ–≤—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö</b>\n\n"
        "1. –¢—Ä—É–¥–æ–≤–æ–π –¥–æ–≥–æ–≤–æ—Ä –±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –¢–ö –†–ö\n"
        "2. –ò—Å–ø—ã—Ç–∞—Ç–µ–ª—å–Ω—ã–π —Å—Ä–æ–∫ > 3 –º–µ—Å—è—Ü–µ–≤ (–Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ)\n"
        "3. –£–≤–æ–ª—å–Ω–µ–Ω–∏–µ –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Å–Ω–æ–≤–∞–Ω–∏—è\n"
        "4. –ù–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∞–∫—Ç–æ–≤ (–ü–í–¢–†, –ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–± –æ–ø–ª–∞—Ç–µ)\n"
        "5. –£–¥–∞–ª—ë–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –±–µ–∑ –¥–æ–ø—Å–æ–≥–ª–∞—à–µ–Ω–∏—è\n\n"
        "80% —Ç—Ä—É–¥–æ–≤—ã—Ö —Å–ø–æ—Ä–æ–≤ ‚Äî –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö."
    ),
    "esop": (
        "üìã <b>5 –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ ESOP</b>\n\n"
        "1. –ù–µ—Ç vesting schedule –≤ –¥–æ–≥–æ–≤–æ—Ä–µ\n"
        "2. –û–ø—Ü–∏–æ–Ω—ã –±–µ–∑ –æ–¥–æ–±—Ä–µ–Ω–∏—è —Å–æ–≤–µ—Ç–∞/—É—á—Ä–µ–¥–∏—Ç–µ–ª–µ–π\n"
        "3. –ù–µ—è—Å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º exit (–∫—Ç–æ –ø–æ–∫—É–ø–∞–µ—Ç –¥–æ–ª—é?)\n"
        "4. –ù–∞–ª–æ–≥–æ–≤—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–µ —É—á—Ç–µ–Ω—ã\n"
        "5. –ù–µ—Ç cliff period ‚Äî —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ —É—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü —Å –¥–æ–ª–µ–π\n\n"
        "ESOP ‚Äî –æ—Ç–ª–∏—á–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ."
    ),
    "it_law": (
        "üìã <b>5 –æ—à–∏–±–æ–∫ –≤ IT-–ø—Ä–∞–≤–µ</b>\n\n"
        "1. –ù–µ—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\n"
        "2. –ö–æ–¥ –±–µ–∑ IP assignment –æ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤\n"
        "3. SaaS-–¥–æ–≥–æ–≤–æ—Ä –±–µ–∑ SLA –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏\n"
        "4. –ù–µ—Ç NDA —Å –ø–æ–¥—Ä—è–¥—á–∏–∫–∞–º–∏ –∏ —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–∞–º–∏\n"
        "5. Open source –≤ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–º –ø—Ä–æ–¥—É–∫—Ç–µ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏—Ü–µ–Ω–∑–∏–π\n\n"
        "IT-–±–∏–∑–Ω–µ—Å –±–µ–∑ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∑–∞—â–∏—Ç—ã ‚Äî –∫–∞–∫ —Å–µ—Ä–≤–µ—Ä –±–µ–∑ —Ñ–∞–π—Ä–≤–æ–ª–∞."
    ),
    "ma": (
        "üìã <b>5 –æ—à–∏–±–æ–∫ –ø—Ä–∏ M&A-—Å–¥–µ–ª–∫–∞—Ö</b>\n\n"
        "1. Due diligence —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π (–Ω—É–∂–µ–Ω –∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π)\n"
        "2. –ù–µ—Ç representations & warranties\n"
        "3. Earn-out –±–µ–∑ —á—ë—Ç–∫–∏—Ö KPI\n"
        "4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ IP-–∞–∫—Ç–∏–≤–æ–≤\n"
        "5. –ù–µ—Ç non-compete –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–∞\n\n"
        "–ö–∞–∂–¥–∞—è –∏–∑ —ç—Ç–∏—Ö –æ—à–∏–±–æ–∫ –º–æ–∂–µ—Ç —Å—Ç–æ–∏—Ç—å –¥–æ 30% –æ—Ç —Å—É–º–º—ã —Å–¥–µ–ª–∫–∏."
    ),
}

_DEFAULT_CHECKLIST = (
    "üìã <b>5 —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –±–∏–∑–Ω–µ—Å–∞</b>\n\n"
    "1. –ù–µ—Ç –ø–∏—Å—å–º–µ–Ω–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏\n"
    "2. –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ —É—á—Ä–µ–¥–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã\n"
    "3. –ù–µ—Ç —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\n"
    "4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è\n"
    "5. –ù–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏ –ø–æ –¢–ö –†–ö\n\n"
    "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ–±—è ‚Äî –µ—Å–ª–∏ –Ω–∞—à–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø—Ä–æ–±–ª–µ–º—É, "
    "–º—ã –ø–æ–º–æ–∂–µ–º –∏—Å–ø—Ä–∞–≤–∏—Ç—å."
)


# ‚îÄ‚îÄ –ö–µ–π—Å—ã –ø–æ —Ç–µ–º–µ (Step 2 ‚Äî 3 –¥–Ω—è) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

_CASE_STUDIES: dict[str, str] = {
    "too": (
        "üíº <b>–ö–µ–π—Å: –ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å –º–µ–∂–¥—É –¢–û–û –∏ –ò–ü</b>\n\n"
        "–ö –Ω–∞–º –æ–±—Ä–∞—Ç–∏–ª—Å—è –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å ‚Äî —É–∂–µ 2 –≥–æ–¥–∞ —Ä–∞–±–æ—Ç–∞–ª –∫–∞–∫ –ò–ü, "
        "–æ–±–æ—Ä–æ—Ç –≤—ã—Ä–æ—Å –¥–æ 200 –º–ª–Ω —Ç–µ–Ω–≥–µ.\n\n"
        "–ú—ã –ø—Ä–æ–≤–µ–ª–∏ –∞–Ω–∞–ª–∏–∑ –∏ –≤—ã—è—Å–Ω–∏–ª–∏: –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –¢–û–û "
        "—Å —Ä–µ–∂–∏–º–æ–º –°–ù–† –Ω–∞–ª–æ–≥–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ —Å–Ω–∏–∂–∞–µ—Ç—Å—è –Ω–∞ 15%.\n\n"
        "–ó–∞ 2 –Ω–µ–¥–µ–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏ –¢–û–û, –ø–µ—Ä–µ–≤–µ–ª–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã "
        "–∏ –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ —É—á—ë—Ç. –≠–∫–æ–Ω–æ–º–∏—è –∑–∞ –ø–µ—Ä–≤—ã–π –≥–æ–¥ ‚Äî 4,2 –º–ª–Ω —Ç–µ–Ω–≥–µ."
    ),
    "mfca": (
        "üíº <b>–ö–µ–π—Å: IT-–∫–æ–º–ø–∞–Ω–∏—è –≤ –ú–§–¶–ê –∑–∞ 3 –º–µ—Å—è—Ü–∞</b>\n\n"
        "–§–∏–Ω—Ç–µ—Ö-—Å—Ç–∞—Ä—Ç–∞–ø –∏–∑ –ê–ª–º–∞—Ç—ã —Ö–æ—Ç–µ–ª –ø—Ä–∏–≤–ª–µ—á—å –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ "
        "–æ—Ç –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–≥–æ —Ñ–æ–Ω–¥–∞. –£—Å–ª–æ–≤–∏–µ —Ñ–æ–Ω–¥–∞ ‚Äî —é—Ä–∏—Å–¥–∏–∫—Ü–∏—è –ú–§–¶–ê.\n\n"
        "–ú—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏ –∫–æ–º–ø–∞–Ω–∏—é "
        "–∏ –ø–æ–ª—É—á–∏–ª–∏ –ª–∏—Ü–µ–Ω–∑–∏—é AFSA –∑–∞ 12 –Ω–µ–¥–µ–ª—å.\n\n"
        "–ò—Ç–æ–≥: –∫–æ–º–ø–∞–Ω–∏—è –ø—Ä–∏–≤–ª–µ–∫–ª–∞ $2M seed-—Ä–∞—É–Ω–¥ —á–µ—Ä–µ–∑ 4 –º–µ—Å—è—Ü–∞."
    ),
    "taxes": (
        "üíº <b>–ö–µ–π—Å: –í–æ–∑–≤—Ä–∞—Ç –ù–î–° –¥–ª—è IT-—ç–∫—Å–ø–æ—Ä—Ç—ë—Ä–∞</b>\n\n"
        "IT-–∫–æ–º–ø–∞–Ω–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∞ SaaS –≤ 5 —Å—Ç—Ä–∞–Ω, –Ω–æ –Ω–µ –∑–Ω–∞–ª–∞, "
        "—á—Ç–æ –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –ù–î–° –∑–∞ –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã.\n\n"
        "–ú—ã –ø–æ–¥–∞–ª–∏ –∑–∞—è–≤–ª–µ–Ω–∏–µ –≤ –Ω–∞–ª–æ–≥–æ–≤—É—é, —Å–æ–±—Ä–∞–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã "
        "–∏ –ø–æ–ª—É—á–∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç 3,8 –º–ª–Ω —Ç–µ–Ω–≥–µ –∑–∞ 2 –∫–≤–∞—Ä—Ç–∞–ª–∞.\n\n"
        "–¢–µ–ø–µ—Ä—å –∫–æ–º–ø–∞–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ù–î–° –∫–∞–∂–¥—ã–π –∫–≤–∞—Ä—Ç–∞–ª."
    ),
    "labor": (
        "üíº <b>–ö–µ–π—Å: –ê—É–¥–∏—Ç —Ç—Ä—É–¥–æ–≤—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤</b>\n\n"
        "–ö–æ–º–ø–∞–Ω–∏—è —Å 80 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏ –ø–æ–ª—É—á–∏–ª–∞ –ø—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ "
        "–æ—Ç —Ç—Ä—É–¥–æ–≤–æ–π –∏–Ω—Å–ø–µ–∫—Ü–∏–∏ ‚Äî 12 –Ω–∞—Ä—É—à–µ–Ω–∏–π.\n\n"
        "–ú—ã –ø—Ä–æ–≤–µ–ª–∏ –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç: –æ–±–Ω–æ–≤–∏–ª–∏ 80 –¥–æ–≥–æ–≤–æ—Ä–æ–≤, "
        "—Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª–∏ –ü–í–¢–†, –ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–± –æ–ø–ª–∞—Ç–µ –∏ 15 —à–∞–±–ª–æ–Ω–æ–≤.\n\n"
        "–ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ ‚Äî 0 –Ω–∞—Ä—É—à–µ–Ω–∏–π. "
        "–®—Ç—Ä–∞—Ñ–æ–≤ —É–¥–∞–ª–æ—Å—å –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é."
    ),
}

_DEFAULT_CASE = (
    "üíº <b>–ò–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏ SOLIS Partners</b>\n\n"
    "–ù–µ–¥–∞–≤–Ω–æ –∫ –Ω–∞–º –æ–±—Ä–∞—Ç–∏–ª–∞—Å—å –∫–æ–º–ø–∞–Ω–∏—è –∏–∑ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ "
    "—Å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º –≤–æ–ø—Ä–æ—Å–æ–º, –ø–æ—Ö–æ–∂–∏–º –Ω–∞ —Ç–µ–º—É –≤–∞—à–µ–≥–æ –≥–∞–π–¥–∞.\n\n"
    "–ú—ã –ø—Ä–æ–≤–µ–ª–∏ –∞–Ω–∞–ª–∏–∑, –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ —Ä–µ—à–∏–ª–∏ –≤–æ–ø—Ä–æ—Å "
    "–∑–∞ 2 –Ω–µ–¥–µ–ª–∏ ‚Äî –±–µ–∑ —à—Ç—Ä–∞—Ñ–æ–≤ –∏ —Å—É–¥–µ–±–Ω—ã—Ö —Ä–∞–∑–±–∏—Ä–∞—Ç–µ–ª—å—Å—Ç–≤.\n\n"
    "–£ –∫–∞–∂–¥–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞ —Å–≤–æ—è —Å–∏—Ç—É–∞—Ü–∏—è ‚Äî –æ–±—Å—É–¥–∏–º –≤–∞—à—É?"
)


# ‚îÄ‚îÄ AI-–ø—Ä–æ–º–ø—Ç—ã (value-first) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async def _generate_value_followup(
    guide_id: str,
    step: int,
    *,
    name: str = "",
    sphere: str = "",
) -> str | None:
    """AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç follow-up —Å –º–∏–∫—Ä–æ—Ü–µ–Ω–Ω–æ—Å—Ç—å—é, –∞ –Ω–µ –Ω–∞–ø–æ–º–∏–Ω–∞–ª–∫—É."""
    topic = _GUIDE_TOPICS.get(guide_id, "")
    if not topic:
        topic = guide_id.replace("_", " ").replace("-", " ")

    sphere_ctx = f" –°—Ñ–µ—Ä–∞ –±–∏–∑–Ω–µ—Å–∞: {sphere}." if sphere else ""
    name_ctx = f" –ò–º—è: {name}." if name else ""

    try:
        from src.bot.utils.ai_client import ask_marketing

        prompts = {
            1: (
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞—á–∞–ª –≥–∞–π–¥ ¬´{topic}¬ª 24—á –Ω–∞–∑–∞–¥."
                f"{name_ctx}{sphere_ctx}\n\n"
                "–ù–∞–ø–∏—à–∏ –ü–û–õ–ï–ó–ù–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–µ –Ω–∞–ø–æ–º–∏–Ω–∞–ª–∫—É!) —Å –º–∏–∫—Ä–æ—Ü–µ–Ω–Ω–æ—Å—Ç—å—é:\n"
                "1. –û–±—Ä–∞—Ç–∏—Å—å –ø–æ –∏–º–µ–Ω–∏\n"
                "2. –î–∞–π –ö–û–ù–ö–†–ï–¢–ù–´–ô —á–µ–∫-–ª–∏—Å—Ç –∏–∑ 3-4 –ø—É–Ω–∫—Ç–æ–≤ ‚Äî "
                "—Ç–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ–π –ø–æ —Ç–µ–º–µ –≥–∞–π–¥–∞ "
                "(—Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —Å—Ñ–µ—Ä–µ, –µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–∞)\n"
                "3. –ü–æ—Å–ª–µ —á–µ–∫-–ª–∏—Å—Ç–∞ —Å–ø—Ä–æ—Å–∏: '–ù–∞—à–ª–∏ —É —Å–µ–±—è —á—Ç–æ-—Ç–æ –∏–∑ —Å–ø–∏—Å–∫–∞?'\n"
                "4. –§–æ—Ä–º–∞—Ç: –¥—Ä—É–∂–µ—Å–∫–∏–π, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è\n"
                "5. –ù–ï –ø–∏—à–∏ '–£–¥–∞–ª–æ—Å—å –ª–∏ –∏–∑—É—á–∏—Ç—å' ‚Äî –¥–∞–π –Ω–æ–≤—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å"
            ),
            2: (
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞—á–∞–ª –≥–∞–π–¥ ¬´{topic}¬ª 3 –¥–Ω—è –Ω–∞–∑–∞–¥."
                f"{name_ctx}{sphere_ctx}\n\n"
                "–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ú –ö–ï–ô–°–û–ú (–Ω–µ –Ω–∞–ø–æ–º–∏–Ω–∞–ª–∫—É!):\n"
                "1. –û–±—Ä–∞—Ç–∏—Å—å –ø–æ –∏–º–µ–Ω–∏\n"
                "2. –†–∞—Å—Å–∫–∞–∂–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –∫–µ–π—Å (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è): "
                "–ø—Ä–æ–±–ª–µ–º–∞ –∫–ª–∏–µ–Ω—Ç–∞ ‚Üí —á—Ç–æ —Å–¥–µ–ª–∞–ª–∏ ‚Üí –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ü–∏—Ñ—Ä–∞—Ö\n"
                "3. –ö–µ–π—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω —Ç–µ–º–µ –≥–∞–π–¥–∞ –∏ —Å—Ñ–µ—Ä–µ\n"
                "4. –í –∫–æ–Ω—Ü–µ: '–•–æ—Ç–∏—Ç–µ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é? "
                "–ù–∞–ø–∏—à–∏—Ç–µ /consult ‚Äî AI-—é—Ä–∏—Å—Ç –æ—Ç–≤–µ—Ç–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ'\n"
                "5. –¢–æ–Ω: —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π, —Å —Ü–∏—Ñ—Ä–∞–º–∏"
            ),
            3: (
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞—á–∞–ª –≥–∞–π–¥ ¬´{topic}¬ª –Ω–µ–¥–µ–ª—é –Ω–∞–∑–∞–¥."
                f"{name_ctx}{sphere_ctx}\n\n"
                "–ù–∞–ø–∏—à–∏ –ú–û–¢–ò–í–ò–†–£–Æ–©–ï–ï —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ–º:\n"
                "1. –û–±—Ä–∞—Ç–∏—Å—å –ø–æ –∏–º–µ–Ω–∏\n"
                "2. –£–ø–æ–º—è–Ω–∏ –æ–¥–Ω–æ –ö–û–ù–ö–†–ï–¢–ù–û–ï –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–µ "
                "–ø–æ —Ç–µ–º–µ –≥–∞–π–¥–∞ (–∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –¥–ª—è 2025-2026)\n"
                "3. –û–±—ä—è—Å–Ω–∏, –ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ –∏–º–µ–Ω–Ω–æ –¥–ª—è –µ–≥–æ —Å—Ñ–µ—Ä—ã\n"
                "4. –ü—Ä–µ–¥–ª–æ–∂–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é 15-–º–∏–Ω—É—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é "
                "—Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–æ–ª—å–∑–æ–π: '–æ–±—Å—É–¥–∏–º, –∫–∞–∫ —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–∞—à –±–∏–∑–Ω–µ—Å'\n"
                "5. –¢–æ–Ω: –∑–∞–±–æ—Ç–ª–∏–≤—ã–π, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –±–µ–∑ —Å–ø–∞–º–∞"
            ),
        }

        instruction = prompts.get(step, prompts[1])
        result = await ask_marketing(
            prompt=instruction,
            max_tokens=350,
            temperature=0.7,
        )
        return result.strip()

    except Exception as e:
        logger.warning("AI followup generation failed: %s", e)
        return None


# ‚îÄ‚îÄ Fallback-—à–∞–±–ª–æ–Ω—ã —Å –º–∏–∫—Ä–æ—Ü–µ–Ω–Ω–æ—Å—Ç—å—é ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def _value_fallback(
    step: int,
    guide_id: str,
    name: str = "",
    sphere: str = "",
) -> str:
    """Fallback —Å –ø–æ–ª–µ–∑–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º –≤–º–µ—Å—Ç–æ –ø—É—Å—Ç–æ–π –Ω–∞–ø–æ–º–∏–Ω–∞–ª–∫–∏."""
    greeting = name if name else "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ"
    sphere_hint = f" –¥–ª—è {sphere}-–±–∏–∑–Ω–µ—Å–∞" if sphere else ""

    if step == 1:
        checklist = _CHECKLISTS.get(guide_id, _DEFAULT_CHECKLIST)
        return (
            f"üëã {greeting}!\n\n"
            f"–í—á–µ—Ä–∞ –≤—ã —Å–∫–∞—á–∞–ª–∏ –Ω–∞—à –≥–∞–π–¥ ‚Äî –Ω–∞–¥–µ–µ–º—Å—è, –æ–Ω –ø–æ–ª–µ–∑–µ–Ω. "
            f"–ê –ø–æ–∫–∞ ‚Äî –º–∏–Ω–∏-—á–µ–∫-–ª–∏—Å—Ç{sphere_hint}:\n\n"
            f"{checklist}"
        )

    if step == 2:
        case = _CASE_STUDIES.get(guide_id, _DEFAULT_CASE)
        return (
            f"üìä {greeting}!\n\n"
            f"–•–æ—Ç–∏–º –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–µ–π—Å–æ–º –∏–∑ –Ω–∞—à–µ–π –ø—Ä–∞–∫—Ç–∏–∫–∏{sphere_hint}:\n\n"
            f"{case}"
        )

    # step 3
    topic = _GUIDE_TOPICS.get(guide_id, "—é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –±–∏–∑–Ω–µ—Å–∞")
    return (
        f"üéØ {greeting}!\n\n"
        f"–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ –≤—Å—Ç—É–ø–∏–ª–∏ –≤ —Å–∏–ª—É "
        f"–∏–∑–º–µ–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –≤–∞—à –±–∏–∑–Ω–µ—Å "
        f"–≤ –æ–±–ª–∞—Å—Ç–∏ ¬´{topic}¬ª.\n\n"
        f"–ú—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º <b>–±–µ—Å–ø–ª–∞—Ç–Ω—É—é –º–∏–Ω–∏-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</b> "
        f"(15 –º–∏–Ω—É—Ç){sphere_hint} ‚Äî —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è "
        f"–∫–∞—Å–∞—é—Ç—Å—è –∏–º–µ–Ω–Ω–æ –≤–∞—Å.\n\n"
        f"üìû –î–ª—è –∑–∞–ø–∏—Å–∏: @SOLISlegal –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ."
    )


# ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def _build_followup_buttons(
    step: int,
    guide_id: str,
    guide_category: str = "",
) -> InlineKeyboardMarkup:
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–Ω–æ–ø–∫–∏ follow-up —Å —É—á—ë—Ç–æ–º —à–∞–≥–∞."""
    buttons: list[list[InlineKeyboardButton]] = []

    if step == 1:
        buttons.append([InlineKeyboardButton(
            text="ü§ñ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å AI-—é—Ä–∏—Å—Ç—É",
            callback_data="ask_question",
        )])
        buttons.append([InlineKeyboardButton(
            text="üìö –î—Ä—É–≥–∏–µ –≥–∞–π–¥—ã –ø–æ —Ç–µ–º–µ",
            callback_data="show_categories",
        )])

    elif step == 2:
        buttons.append([InlineKeyboardButton(
            text="ü§ñ –†–∞–∑–æ–±—Ä–∞—Ç—å –º–æ—é —Å–∏—Ç—É–∞—Ü–∏—é",
            callback_data="ask_question",
        )])
        buttons.append([InlineKeyboardButton(
            text="üìû –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é",
            callback_data="book_consultation",
        )])
        buttons.append([InlineKeyboardButton(
            text="üìö –ï—â—ë –≥–∞–π–¥—ã",
            callback_data="show_categories",
        )])

    else:  # step 3
        buttons.append([InlineKeyboardButton(
            text="üìû –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é",
            callback_data="book_consultation",
        )])
        buttons.append([InlineKeyboardButton(
            text="ü§ñ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å AI-—é—Ä–∏—Å—Ç—É",
            callback_data="ask_question",
        )])
        buttons.append([InlineKeyboardButton(
            text="üìö –í—Å–µ –≥–∞–π–¥—ã",
            callback_data="show_categories",
        )])

    # –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Ç–µ–º—É (–≤ –∫–∞–∂–¥–æ–º follow-up)
    if guide_category:
        import re
        slug = re.sub(r"[^\w\s-]", "", guide_category.lower().strip())
        slug = re.sub(r"[\s-]+", "_", slug).strip("_")[:30]
        if slug:
            buttons.append([InlineKeyboardButton(
                text=f"üì© –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–æ–≤—ã–µ –≥–∞–π–¥—ã ¬´{guide_category[:25]}¬ª",
                callback_data=f"topic_sub_{slug}",
            )])

    return InlineKeyboardMarkup(inline_keyboard=buttons)


# ‚îÄ‚îÄ –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async def send_followup_message(
    user_id: int,
    guide_id: str,
    step: int,
    *,
    bot: Bot,
    google: GoogleSheetsClient,
    cache: TTLCache,
) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç follow-up —Å –º–∏–∫—Ä–æ—Ü–µ–Ω–Ω–æ—Å—Ç—å—é.

    Step 1 (24—á): —á–µ–∫-–ª–∏—Å—Ç –æ—à–∏–±–æ–∫ –ø–æ —Ç–µ–º–µ –≥–∞–π–¥–∞.
    Step 2 (3 –¥–Ω—è): —Ä–∞–∑–±–æ—Ä –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–µ–π—Å–∞.
    Step 3 (7 –¥–Ω–µ–π): –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é + –ø–æ–¥–ø–∏—Å–∫–∞.
    """
    try:
        from src.database.crud import get_lead_by_user_id

        lead = await get_lead_by_user_id(user_id)
        lead_name = lead.name if lead else ""
        lead_sphere = getattr(lead, "business_sphere", "") or "" if lead else ""

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≥–∞–π–¥–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
        catalog = await cache.get_or_fetch("catalog", google.get_guides_catalog)
        guide_category = ""
        for g in catalog:
            if str(g.get("id", "")) == guide_id:
                guide_category = g.get("category", "")
                break

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º: –º–æ–∂–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –ø—Ä–æ—à—ë–ª –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é?
        consult_log = await google.get_consult_log(limit=50)
        user_consulted = any(
            str(row.get("user_id", row.get("User ID", ""))) == str(user_id)
            for row in consult_log
        )

        if user_consulted and step == 1:
            greeting = f"üëã {lead_name}, —Ä" if lead_name else "üëã –†"
            text = (
                f"{greeting}–∞–¥—ã, —á—Ç–æ –≤—ã —É–∂–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –Ω–∞—à–µ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π!\n\n"
                "–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –Ω–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –Ω–∞–∂–º–∏—Ç–µ /consult, "
                "–∞ –¥–ª—è —É–≥–ª—É–±–ª—ë–Ω–Ω–æ–π –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏ ‚Äî @SOLISlegal."
            )
            kb = _build_followup_buttons(step, guide_id, guide_category)
            await bot.send_message(chat_id=user_id, text=text, reply_markup=kb)
            logger.info("Follow-up (consulted): user=%s step=%d", user_id, step)
            return

        # –ü—Ä–æ–±—É–µ–º AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å value-first –ø—Ä–æ–º–ø—Ç–∞–º–∏
        ai_text = await _generate_value_followup(
            guide_id, step, name=lead_name, sphere=lead_sphere,
        )

        # Fallback: Sheets -> value-—à–∞–±–ª–æ–Ω
        if not ai_text:
            followup_texts = await cache.get_or_fetch(
                "followup_series",
                google.get_followup_series,
            )
            specific_key = f"{guide_id}_step_{step}"
            generic_key = f"step_{step}"

            ai_text = (
                followup_texts.get(specific_key)
                or followup_texts.get(generic_key)
                or _value_fallback(step, guide_id, lead_name, lead_sphere)
            )

        if not ai_text:
            logger.warning("Follow-up text empty: step=%d guide=%s", step, guide_id)
            return

        keyboard = _build_followup_buttons(step, guide_id, guide_category)

        try:
            await bot.send_message(
                chat_id=user_id,
                text=ai_text,
                reply_markup=keyboard,
            )
        except Exception:
            await bot.send_message(
                chat_id=user_id,
                text=ai_text,
                reply_markup=keyboard,
                parse_mode=None,
            )

        logger.info(
            "Follow-up sent: user=%s guide=%s step=%d sphere=%s",
            user_id, guide_id, step, lead_sphere or "-",
        )
    except Exception as e:
        logger.error(
            "Follow-up error: user=%s step=%d err=%s",
            user_id, step, e,
        )
