"""–ï–¥–∏–Ω—ã–π AI-–∫–ª–∏–µ–Ω—Ç: Gemini (—é—Ä–∏—Å—Ç) + GPT (–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥/—Å—Ç—Ä–∞—Ç–µ–≥).

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
    - AIOrchestrator ‚Äî –µ–¥–∏–Ω—ã–π –∫–ª–∞—Å—Å —Å aiohttp, retry, fallback
    - Gemini 2.0 Flash  ‚Üí —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, –æ—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞–º
    - GPT-4o-mini       ‚Üí –º–∞—Ä–∫–µ—Ç–∏–Ω–≥, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, –∫–æ–Ω—Ç–µ–Ω—Ç, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    from src.bot.utils.ai_client import ask_legal, ask_marketing, ask_content
    answer = await ask_legal("–ö–∞–∫ —É–≤–æ–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ –¢–ö –†–ö?")
    ideas  = await ask_marketing("–ü—Ä–∏–¥—É–º–∞–π –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω", context=...)
    html   = await ask_content("–û—Ñ–æ—Ä–º–∏ —Å—Ç–∞—Ç—å—é...", raw_text=...)
"""

import asyncio
import json
import logging

import aiohttp

from src.config import settings

logger = logging.getLogger(__name__)

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  –°–ò–°–¢–ï–ú–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò (PERSONA)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

LEGAL_PERSONA = """–¢—ã ‚Äî AI —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ñ–∏—Ä–º—ã SOLIS Partners.

–û –ö–û–ú–ü–ê–ù–ò–ò:
SOLIS Partners ‚Äî –≤–µ–¥—É—â–∞—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è —Ñ–∏—Ä–º–∞ –≤ –ê–ª–º–∞—Ç—ã, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω.
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: IT-–ø—Ä–∞–≤–æ, –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–æ, M&A (—Å–ª–∏—è–Ω–∏—è –∏ –ø–æ–≥–ª–æ—â–µ–Ω–∏—è),
—Å—É–¥–µ–±–Ω—ã–µ —Å–ø–æ—Ä—ã, –ø—Ä–∞–≤–æ –ú–§–¶–ê (–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä ¬´–ê—Å—Ç–∞–Ω–∞¬ª, –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –ø—Ä–∞–≤–æ),
—Ç—Ä—É–¥–æ–≤–æ–µ –ø—Ä–∞–≤–æ, –Ω–∞–ª–æ–≥–æ–≤–æ–µ –ø—Ä–∞–≤–æ, –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å.
–°–∞–π—Ç: solispartners.kz | Telegram-–∫–∞–Ω–∞–ª: @SOLISlegal

–¢–í–û–Ø –†–û–õ–¨:
–¢—ã ‚Äî –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —é—Ä–∏—Å—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É
–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫—É –ø–æ –µ–≥–æ –≤–æ–ø—Ä–æ—Å—É, –ø–æ–∫–∞–∑–∞—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—É —Ñ–∏—Ä–º—ã
–∏ –º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∑–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π.

–ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–ê:
1. –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ: –∫—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç ‚Üí –ø—Ä–∞–≤–æ–≤–∞—è –æ—Å–Ω–æ–≤–∞ ‚Üí —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
2. –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –ö–û–ù–ö–†–ï–¢–ù–´–ï —Å—Ç–∞—Ç—å–∏ –∑–∞–∫–æ–Ω–æ–≤ –†–ö (–¢–ö –†–ö, –ì–ö –†–ö, –ù–ö –†–ö, –£–ö –†–ö,
   –ó–∞–∫–æ–Ω –æ –¢–û–û, –ó–∞–∫–æ–Ω –æ–± –ê–û, –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–æ–Ω–Ω—ã–π –∑–∞–∫–æ–Ω –æ –ú–§–¶–ê –∏ —Ç.–¥.).
3. –ò—Å–ø–æ–ª—å–∑—É–π HTML-—Ä–∞–∑–º–µ—Ç–∫—É Telegram:
   - <b>–∂–∏—Ä–Ω—ã–π</b> –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
   - <code>—Å—Ç. 52 –¢–ö –†–ö</code> –¥–ª—è —Å—Å—ã–ª–æ–∫ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –∑–∞–∫–æ–Ω–æ–≤
   - <i>–∫—É—Ä—Å–∏–≤</i> –¥–ª—è –ø–æ—è—Å–Ω–µ–Ω–∏–π
   - –ú–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ ‚Ä¢ —Å–∏–º–≤–æ–ª
4. –û–±—ä—ë–º: 3-5 –∞–±–∑–∞—Ü–µ–≤, –Ω–µ –±–æ–ª—å—à–µ 800 —Å–ª–æ–≤.
5. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Ä–∞–∑–±–∏–≤–∞–π –æ—Ç–≤–µ—Ç –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏:
   –ò—Å–ø–æ–ª—å–∑—É–π ¬´‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ¬ª –º–µ–∂–¥—É —Å–µ–∫—Ü–∏—è–º–∏.
   –ö–∞–∂–¥—ã–π –±–ª–æ–∫ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫-—ç–º–æ–¥–∑–∏:
   ‚öñÔ∏è ‚Äî –ø—Ä–∞–≤–æ–≤–∞—è –æ—Å–Ω–æ–≤–∞
   üìã ‚Äî —á—Ç–æ –¥–µ–ª–∞—Ç—å (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)
   ‚ö†Ô∏è ‚Äî —Ä–∏—Å–∫–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
   üí° ‚Äî –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç
6. –í –∫–æ–Ω—Ü–µ –í–°–ï–ì–î–ê —Ä–µ–∫–æ–º–µ–Ω–¥—É–π: ¬´–î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–ø—Ä–æ—Å–∞
   –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º SOLIS Partners¬ª.
7. –ù–ï –¥–∞–≤–∞–π –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∞–≤–æ–≤—ã—Ö –∑–∞–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ç–æ–ª—å–∫–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫—É.
8. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ù–ï —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π ‚Äî –≤–µ–∂–ª–∏–≤–æ –æ–±—ä—è—Å–Ω–∏ —Å–≤–æ—é —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é.
9. –û—Ç–≤–µ—á–∞–π –Ω–∞ —è–∑—ã–∫–µ –≤–æ–ø—Ä–æ—Å–∞ (—Ä—É—Å—Å–∫–∏–π –∏–ª–∏ –∫–∞–∑–∞—Ö—Å–∫–∏–π).
10. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è –ú–§–¶–ê ‚Äî —É–∫–∞–∂–∏, —á—Ç–æ —Ç–∞–º –¥–µ–π—Å—Ç–≤—É–µ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –ø—Ä–∞–≤–æ.
11. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π Markdown (**, __, ``` –∏ —Ç.–¥.) ‚Äî –¢–û–õ–¨–ö–û HTML-—Ç–µ–≥–∏ Telegram."""

MARKETING_PERSONA = """–¢—ã ‚Äî AI –º–∞—Ä–∫–µ—Ç–∏–Ω–≥-—Å—Ç—Ä–∞—Ç–µ–≥ –∏ PR-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Ñ–∏—Ä–º—ã SOLIS Partners.

–û –ö–û–ú–ü–ê–ù–ò–ò:
SOLIS Partners ‚Äî –≤–µ–¥—É—â–∞—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è —Ñ–∏—Ä–º–∞ –≤ –ê–ª–º–∞—Ç—ã, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω.
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: IT-–ø—Ä–∞–≤–æ, –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–æ, M&A, –ú–§–¶–ê (–∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –ø—Ä–∞–≤–æ),
—Ç—Ä—É–¥–æ–≤–æ–µ –ø—Ä–∞–≤–æ, –Ω–∞–ª–æ–≥–æ–≤–æ–µ –ø—Ä–∞–≤–æ, IP.
–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–∏, —Å—Ç–∞—Ä—Ç–∞–ø—ã, IT-–∫–æ–º–ø–∞–Ω–∏–∏, –∏–Ω–≤–µ—Å—Ç–æ—Ä—ã,
CEO –∏ —é—Ä–∏—Å—Ç—ã –∫–æ–º–ø–∞–Ω–∏–π –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ –∏ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –ê–∑–∏–∏.
Tone of voice: —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–π; —É–≤–µ—Ä–µ–Ω–Ω—ã–π, –±–µ–∑ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –∂–∞—Ä–≥–æ–Ω–∞
–¥–ª—è —à–∏—Ä–æ–∫–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏; —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫—É—é –ø–æ–ª—å–∑—É.

–¢–í–û–Ø –†–û–õ–¨:
–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –º–∞—Ä–∫–µ—Ç–∏–Ω–≥-–¥–∏—Ä–µ–∫—Ç–æ—Ä —Å 10+ –≥–æ–¥–∞–º–∏ –æ–ø—ã—Ç–∞ –≤ legal marketing.
–¢—ã –æ—Ç–≤–µ—á–∞–µ—à—å –∑–∞:
‚Ä¢ –ö–æ–Ω—Ç–µ–Ω—Ç-—Å—Ç—Ä–∞—Ç–µ–≥–∏—é (—Å—Ç–∞—Ç—å–∏, –ø–æ—Å—Ç—ã, –≥–∞–π–¥—ã, –∫–µ–π—Å—ã)
‚Ä¢ Telegram-–∫–∞–Ω–∞–ª @SOLISlegal
‚Ä¢ Lead generation –∏ –≤–æ—Ä–æ–Ω–∫–∏ –ø—Ä–æ–¥–∞–∂
‚Ä¢ –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏—Ä–º—ã –∫–∞–∫ –ª–∏–¥–µ—Ä–∞ —Ä—ã–Ω–∫–∞
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞

–ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´:
1. –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –ö–û–ù–ö–†–ï–¢–ù–´–ï –¥–µ–π—Å—Ç–≤–∏—è —Å —á—ë—Ç–∫–∏–º–∏ —à–∞–≥–∞–º–∏.
2. –ï—Å–ª–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å –∫–æ–Ω—Ç–µ–Ω—Ç ‚Äî –¥–∞–≤–∞–π –ì–û–¢–û–í–´–ï –∑–∞–≥–æ–ª–æ–≤–∫–∏ (3-5 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤).
3. –î—É–º–∞–π –æ –≤–æ—Ä–æ–Ω–∫–µ: –æ—Å–≤–µ–¥–æ–º–ª—ë–Ω–Ω–æ—Å—Ç—å ‚Üí –∏–Ω—Ç–µ—Ä–µ—Å ‚Üí –ª–∏–¥ ‚Üí –∫–ª–∏–µ–Ω—Ç.
4. –ö–æ–Ω—Ç–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–û–õ–ï–ó–ù–´–ú: –Ω–µ —Ä–µ–∫–ª–∞–º–∞, –∞ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞.
5. –£—á–∏—Ç—ã–≤–∞–π —Å–ø–µ—Ü–∏—Ñ–∏–∫—É –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞: –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ –†–ö, –º–µ—Å—Ç–Ω—ã–π —Ä—ã–Ω–æ–∫.
6. –ü—Ä–µ–¥–ª–∞–≥–∞–π —Ñ–æ—Ä–º–∞—Ç—ã: —Å—Ç–∞—Ç—å—è –Ω–∞ —Å–∞–π—Ç + –∫–æ—Ä–æ—Ç–∫–∏–π –ø–æ—Å—Ç –≤ Telegram-–∫–∞–Ω–∞–ª +
   –≤–æ–∑–º–æ–∂–Ω—ã–π –≥–∞–π–¥ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.
7. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ (–ª–∏–¥—ã, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É) –∏ –¥–∞–≤–∞–π —á–∏—Å–ª–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
8. –°—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞: –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É, —Å emoji –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ.
9. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
10. –ü–æ–º–Ω–∏: —Ç—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–µ—à—å, —Ç—ã –ò–ù–ò–¶–ò–ò–†–£–ï–®–¨. –ü—Ä–µ–¥–ª–∞–≥–∞–π —Ç–æ,
    –æ —á—ë–º –∞–¥–º–∏–Ω –µ—â—ë –Ω–µ –ø–æ–¥—É–º–∞–ª.
11. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑—É–π HTML-—Ç–µ–≥–∏ Telegram (<b>, <i>, <code>).
    –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π Markdown."""

CONTENT_PERSONA = """–¢—ã ‚Äî AI-—Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ –∫–æ–Ω—Ç–µ–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Ñ–∏—Ä–º—ã SOLIS Partners.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ü—Ä–µ–≤—Ä–∞—â–∞—Ç—å —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—å–∏.

–ü–†–ê–í–ò–õ–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø:
1. –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ HTML (—Ç–µ–≥–∏: <h2>, <h3>, <p>, <ul>, <li>,
   <strong>, <em>, <blockquote>).
2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç–∞—Ç—å–∏:
   - –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ (1-2 –∞–±–∑–∞—Ü–∞, –∑–∞—Ü–µ–ø–∏—Ç—å —á–∏—Ç–∞—Ç–µ–ª—è –ø—Ä–æ–±–ª–µ–º–æ–π)
   - –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å (—Ä–∞–∑–±–∏—Ç–∞—è –Ω–∞ —Å–µ–∫—Ü–∏–∏ —Å –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ <h2>/<h3>)
   - –ó–∞–∫–ª—é—á–µ–Ω–∏–µ (—Ä–µ–∑—é–º–µ + CTA: –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ SOLIS Partners)
3. –°–æ—Ö—Ä–∞–Ω—è–π –í–°–Æ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.
4. –°—Å—ã–ª–∫–∏ –Ω–∞ –∑–∞–∫–æ–Ω—ã: <em>—Å—Ç. 52 –¢–ö –†–ö</em>.
5. –ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã: <strong>–∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è</strong>.
6. –î–ª–∏–Ω–Ω—ã–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è: <ul><li>.
7. –¶–∏—Ç–∞—Ç—ã –∏–∑ –∑–∞–∫–æ–Ω–æ–≤: <blockquote>.
8. –ù–µ –¥–æ–±–∞–≤–ª—è–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ.
9. Tone of voice: —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –¥–æ—Å—Ç—É–ø–Ω—ã–π, –±–µ–∑ –∑–∞–Ω—É–¥—Å—Ç–≤–∞.
10. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–π: title, description, category."""

CRITIC_PERSONA = """–¢—ã ‚Äî AI-—Ä–µ—Ü–µ–Ω–∑–µ–Ω—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ —Ñ–∏—Ä–º—ã SOLIS Partners.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç AI-—é—Ä–∏—Å—Ç–∞ –Ω–∞:
1. –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ —Å—Ç–∞—Ç–µ–π, –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–∫–æ–Ω—ã)
2. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∏–ª—é SOLIS Partners (—ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –¥–æ—Å—Ç—É–ø–Ω—ã–π, –±–µ–∑ –∑–∞–Ω—É–¥—Å—Ç–≤–∞)
3. –ù–∞–ª–∏—á–∏–µ –¥–∏—Å–∫–ª–µ–π–º–µ—Ä–∞ (–æ—Ç–≤–µ—Ç –Ω–æ—Å–∏—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä)
4. –ù–∞–ª–∏—á–∏–µ CTA (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ SOLIS Partners)
5. –õ–æ–≥–∏—á–µ—Å–∫—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
6. –ì–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏ ‚Äî –≤—ã–¥—É–º–∞–Ω–Ω—ã–µ —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –≤–æ–ø—Ä–æ—Å–µ

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —Ö–æ—Ä–æ—à–∏–π: "–û–ö: –æ—Ç–≤–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º."
–ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã: "–û–®–ò–ë–ö–ê: [–æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã]. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: [—á—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å]."

–ë—É–¥—å —Å—Ç—Ä–æ–≥–∏–º, –Ω–æ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–º. –õ—É—á—à–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ö–æ—Ä–æ—à–∏–π –æ—Ç–≤–µ—Ç, —á–µ–º –æ–¥–æ–±—Ä–∏—Ç—å –ø–ª–æ—Ö–æ–π."""

CHANNEL_POST_PERSONA = """–¢—ã ‚Äî SMM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Ñ–∏—Ä–º—ã SOLIS Partners.
–¢—ã –ø–∏—à–µ—à—å –ø–æ—Å—Ç—ã –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞ @SOLISlegal.

–§–û–†–ú–ê–¢: HTML (—Ç–µ–≥–∏ Telegram: <b>, <i>, <code>, <a>, <blockquote>, <tg-spoiler>)

–í–ò–ó–£–ê–õ–¨–ù–´–ô –°–¢–ê–ù–î–ê–†–¢:
- –ó–∞–≥–æ–ª–æ–≤–æ–∫: <b>üî• –¶–µ–ø–ª—è—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫</b>
- –ü–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞: —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
- –ö–∞–∂–¥—ã–π –±–ª–æ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —ç–º–æ–¥–∑–∏:
  ‚öñÔ∏è ‚Äî –ø—Ä–∞–≤–æ, üìå ‚Äî —Å—É—Ç—å, ‚úÖ ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, üí° ‚Äî –∏–Ω—Å–∞–π–¥
- –¶–∏—Ç–∞—Ç—ã –∑–∞–∫–æ–Ω–æ–≤: <blockquote><i>"–¢–µ–∫—Å—Ç –∑–∞–∫–æ–Ω–∞"</i></blockquote>
- –ö–æ—Ä–æ—Ç–∫–∏–µ –∞–±–∑–∞—Ü—ã (2-3 —Å—Ç—Ä–æ–∫–∏ –º–∞–∫—Å–∏–º—É–º)
- –ò–Ω—Ç—Ä–∏–≥–∞ —á–µ—Ä–µ–∑ <tg-spoiler>—Å–∫—Ä—ã—Ç—ã–π —Ç–µ–∫—Å—Ç</tg-spoiler>
- –ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã: <b>–∂–∏—Ä–Ω—ã–º</b>
- –ù–æ–º–µ—Ä–∞ —Å—Ç–∞—Ç–µ–π: <code>—Å—Ç. 52 –¢–ö –†–ö</code>

–°–¢–†–£–ö–¢–£–†–ê –ü–û–°–¢–ê:
1. <b>–ó–∞–≥–æ–ª–æ–≤–æ–∫-—Ö—É–∫</b> (–ø—Ä–æ–±–ª–µ–º–∞ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å)
2. ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å)
3. üìå <b>–°—É—Ç—å:</b> –ö–ª—é—á–µ–≤–æ–π —Ç–µ–∑–∏—Å
4. ‚úÖ <b>–ß—Ç–æ –¥–µ–ª–∞—Ç—å:</b> 2-3 –±—É–ª–ª–∏—Ç–∞ —á–µ—Ä–µ–∑ ‚Ä¢
5. <blockquote>–≠–∫—Å–ø–µ—Ä—Ç–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞</blockquote>
6. üëâ CTA —Å–æ —Å—Å—ã–ª–∫–æ–π

–î–õ–ò–ù–ê: 500-1500 —Å–∏–º–≤–æ–ª–æ–≤. Tone: —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –Ω–æ –∂–∏–≤–æ–π.
–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ö–µ—à—Ç–µ–≥–∏. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π Markdown ‚Äî –¢–û–õ–¨–ö–û HTML."""


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  AIOrchestrator ‚Äî –µ–¥–∏–Ω—ã–π async-–∫–ª–∏–µ–Ω—Ç —Å retry –∏ fallback
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

GEMINI_API_URL = (
    "https://generativelanguage.googleapis.com/v1beta/"
    "models/gemini-2.0-flash:generateContent"
)
OPENAI_API_URL = "https://api.openai.com/v1/chat/completions"
OPENAI_IMAGES_URL = "https://api.openai.com/v1/images/generations"


class AIOrchestrator:
    """–ï–¥–∏–Ω—ã–π AI-–∫–ª–∏–µ–Ω—Ç —Å aiohttp, retry, fallback –∏ —Ç—Ä–µ–∫–∏–Ω–≥–æ–º —Ç–æ–∫–µ–Ω–æ–≤."""

    def __init__(self) -> None:
        self._session: aiohttp.ClientSession | None = None
        self.total_tokens_used: int = 0

    async def _get_session(self) -> aiohttp.ClientSession:
        if self._session is None or self._session.closed:
            self._session = aiohttp.ClientSession(
                timeout=aiohttp.ClientTimeout(total=60),
            )
        return self._session

    async def close(self) -> None:
        """–ó–∞–∫—Ä—ã—Ç—å HTTP-—Å–µ—Å—Å–∏—é."""
        if self._session and not self._session.closed:
            await self._session.close()
            self._session = None

    # ‚îÄ‚îÄ HTTP —Å retry ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def _request_with_retry(
        self,
        url: str,
        payload: dict,
        headers: dict | None = None,
        max_retries: int = 3,
    ) -> dict:
        """POST-–∑–∞–ø—Ä–æ—Å —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff –¥–ª—è 429 –∏ 5xx."""
        session = await self._get_session()
        delay = 1.0
        last_exc: Exception | None = None

        for attempt in range(max_retries):
            try:
                async with session.post(
                    url, json=payload, headers=headers or {},
                ) as resp:
                    if resp.status == 429:
                        retry_after = int(resp.headers.get("Retry-After", delay))
                        logger.warning(
                            "API 429, retry %d/%d in %ds",
                            attempt + 1, max_retries, retry_after,
                        )
                        await asyncio.sleep(retry_after)
                        delay *= 2
                        continue
                    if resp.status >= 500:
                        logger.warning(
                            "API %d, retry %d/%d in %.1fs",
                            resp.status, attempt + 1, max_retries, delay,
                        )
                        await asyncio.sleep(delay)
                        delay *= 2
                        continue
                    body = await resp.json()
                    if resp.status >= 400:
                        error_msg = json.dumps(body, ensure_ascii=False)[:200]
                        raise RuntimeError(
                            f"API error {resp.status}: {error_msg}"
                        )
                    return body
            except (aiohttp.ClientError, asyncio.TimeoutError) as e:
                last_exc = e
                if attempt == max_retries - 1:
                    raise RuntimeError(f"API request failed: {e}") from e
                logger.warning(
                    "Request error, retry %d/%d: %s", attempt + 1, max_retries, e,
                )
                await asyncio.sleep(delay)
                delay *= 2

        raise RuntimeError(f"Max retries exceeded: {last_exc}")

    # ‚îÄ‚îÄ Gemini ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def call_gemini(
        self,
        prompt: str,
        system: str,
        max_tokens: int = 1024,
        temperature: float = 0.7,
    ) -> str:
        """–ó–∞–ø—Ä–æ—Å –∫ Gemini API."""
        if not settings.GEMINI_API_KEY:
            raise RuntimeError("GEMINI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")

        url = f"{GEMINI_API_URL}?key={settings.GEMINI_API_KEY}"
        payload = {
            "contents": [{"parts": [{"text": f"{system}\n\n{prompt}"}]}],
            "generationConfig": {
                "temperature": temperature,
                "maxOutputTokens": max_tokens,
                "topP": 0.9,
            },
            "safetySettings": [
                {"category": c, "threshold": "BLOCK_ONLY_HIGH"}
                for c in [
                    "HARM_CATEGORY_HARASSMENT",
                    "HARM_CATEGORY_HATE_SPEECH",
                    "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                    "HARM_CATEGORY_DANGEROUS_CONTENT",
                ]
            ],
        }

        result = await self._request_with_retry(url, payload)

        candidates = result.get("candidates", [])
        if not candidates:
            raise RuntimeError("Gemini: –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
        parts = candidates[0].get("content", {}).get("parts", [])
        if not parts:
            raise RuntimeError("Gemini: –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞")
        answer = parts[0].get("text", "").strip()
        if not answer:
            raise RuntimeError("Gemini: –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç")

        # Track tokens
        usage = result.get("usageMetadata", {})
        self.total_tokens_used += usage.get("totalTokenCount", 0)

        return answer

    # ‚îÄ‚îÄ OpenAI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def call_openai(
        self,
        prompt: str,
        system: str,
        max_tokens: int = 2048,
        temperature: float = 0.7,
        model: str = "gpt-4o-mini",
    ) -> str:
        """–ó–∞–ø—Ä–æ—Å –∫ OpenAI API."""
        if not settings.OPENAI_API_KEY:
            raise RuntimeError("OPENAI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")

        payload = {
            "model": model,
            "messages": [
                {"role": "system", "content": system},
                {"role": "user", "content": prompt},
            ],
            "max_tokens": max_tokens,
            "temperature": temperature,
        }
        headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {settings.OPENAI_API_KEY}",
        }

        result = await self._request_with_retry(OPENAI_API_URL, payload, headers)

        choices = result.get("choices", [])
        if not choices:
            raise RuntimeError("OpenAI: –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
        answer = choices[0].get("message", {}).get("content", "").strip()
        if not answer:
            raise RuntimeError("OpenAI: –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç")

        # Track tokens
        usage = result.get("usage", {})
        self.total_tokens_used += usage.get("total_tokens", 0)

        return answer

    # ‚îÄ‚îÄ Fallback: GPT ‚Üí Gemini ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def call_with_fallback(
        self,
        prompt: str,
        system: str,
        *,
        primary: str = "openai",
        max_tokens: int = 2048,
        temperature: float = 0.7,
    ) -> str:
        """–ó–∞–ø—Ä–æ—Å —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º fallback –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é –º–æ–¥–µ–ª—å."""
        try:
            if primary == "openai":
                return await self.call_openai(
                    prompt, system,
                    max_tokens=max_tokens, temperature=temperature,
                )
            else:
                return await self.call_gemini(
                    prompt, system,
                    max_tokens=max_tokens, temperature=temperature,
                )
        except Exception as e:
            fallback = "gemini" if primary == "openai" else "openai"
            logger.warning(
                "%s failed, fallback to %s: %s", primary, fallback, e,
            )
            if fallback == "gemini":
                return await self.call_gemini(
                    prompt, system,
                    max_tokens=max_tokens, temperature=temperature,
                )
            else:
                return await self.call_openai(
                    prompt, system,
                    max_tokens=max_tokens, temperature=temperature,
                )


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä (singleton)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

_orchestrator: AIOrchestrator | None = None


def get_orchestrator() -> AIOrchestrator:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π AIOrchestrator (—Å–æ–∑–¥–∞—ë—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ)."""
    global _orchestrator
    if _orchestrator is None:
        _orchestrator = AIOrchestrator()
    return _orchestrator


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  –ü–£–ë–õ–ò–ß–ù–´–ï –§–£–ù–ö–¶–ò–ò (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


async def ask_legal(question: str, *, context: str = "", max_tokens: int = 1024) -> str:
    """–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è (Gemini).

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è: /consult, Auto-FAQ, –æ—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞–º.
    """
    ai = get_orchestrator()
    prompt = ""
    if context:
        prompt += f"–†–ï–õ–ï–í–ê–ù–¢–ù–´–ô –ö–û–ù–¢–ï–ö–°–¢ –ö–û–ú–ü–ê–ù–ò–ò:\n{context}\n\n"
    prompt += f"–í–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞:\n{question}"
    return await ai.call_gemini(
        prompt, LEGAL_PERSONA,
        max_tokens=max_tokens, temperature=0.5,
    )


async def ask_legal_safe(question: str, *, context: str = "", max_tokens: int = 1024) -> str:
    """–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –¥–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π (Creator + Critic).

    –®–∞–≥ 1: Gemini –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç (Creator).
    –®–∞–≥ 2: GPT –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –æ—à–∏–±–∫–∏ (Critic).
    –ï—Å–ª–∏ Critic –Ω–∞—Ö–æ–¥–∏—Ç –ø—Ä–æ–±–ª–µ–º—É ‚Äî –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å —É—á—ë—Ç–æ–º –∑–∞–º–µ—á–∞–Ω–∏–π.
    """
    ai = get_orchestrator()

    # –®–∞–≥ 1: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
    answer = await ask_legal(question, context=context, max_tokens=max_tokens)

    # –®–∞–≥ 2: –∫—Ä–∏—Ç–∏–∫–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å –¥–ª—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)
    critic_prompt = (
        f"–í–û–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê:\n{question}\n\n"
        f"–û–¢–í–ï–¢ AI-–Æ–†–ò–°–¢–ê:\n{answer}\n\n"
        "–ü—Ä–æ–≤–µ—Ä—å –æ—Ç–≤–µ—Ç –ø–æ –≤—Å–µ–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –∏ –¥–∞–π –≤–µ—Ä–¥–∏–∫—Ç."
    )
    try:
        review = await ai.call_with_fallback(
            critic_prompt, CRITIC_PERSONA,
            primary="openai", max_tokens=512, temperature=0.3,
        )
    except Exception as e:
        logger.warning("Critic failed, returning original answer: %s", e)
        return answer

    # –ï—Å–ª–∏ Critic –Ω–∞—à—ë–ª –æ—à–∏–±–∫—É ‚Äî –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è
    if "–û–®–ò–ë–ö–ê" in review.upper() or "ERROR" in review.upper():
        logger.info("Critic rejected answer, regenerating with feedback")
        corrected = await ask_legal(
            f"{question}\n\n–í–ê–ñ–ù–û: –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–≤–µ—Ç –±—ã–ª –æ—Ç–∫–ª–æ–Ω—ë–Ω —Ä–µ—Ü–µ–Ω–∑–µ–Ω—Ç–æ–º. "
            f"–ó–∞–º–µ—á–∞–Ω–∏—è: {review}\n"
            f"–ò—Å–ø—Ä–∞–≤—å –æ—Ç–≤–µ—Ç —Å —É—á—ë—Ç–æ–º –∑–∞–º–µ—á–∞–Ω–∏–π.",
            context=context,
            max_tokens=max_tokens,
        )
        return corrected

    return answer


async def ask_marketing(
    prompt: str,
    *,
    context: str = "",
    history: str = "",
    max_tokens: int = 2048,
    temperature: float = 0.7,
) -> str:
    """–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (GPT -> fallback Gemini).

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è: /chat, –∏–¥–µ–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –¥–∞–π–¥–∂–µ—Å—Ç, –∞–Ω–∞–ª–∏–∑.
    """
    ai = get_orchestrator()
    full_prompt = ""
    if context:
        full_prompt += f"–ö–û–ù–¢–ï–ö–°–¢ –ö–û–ú–ü–ê–ù–ò–ò –ò –ê–ù–ê–õ–ò–¢–ò–ö–ê:\n{context}\n\n"
    if history:
        full_prompt += f"–ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê:\n{history}\n\n"
    full_prompt += f"–ó–ê–ü–†–û–°:\n{prompt}"

    return await ai.call_with_fallback(
        full_prompt, MARKETING_PERSONA,
        primary="openai",
        max_tokens=max_tokens, temperature=temperature,
    )


async def ask_content(
    raw_text: str,
    *,
    task: str = "format_article",
    max_tokens: int = 4096,
) -> str:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–µ–π, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤ (GPT).

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è: /publish, AI-–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–µ–π, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤.
    """
    if task == "format_article":
        instruction = (
            "–û—Ñ–æ—Ä–º–∏ —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç–∞—Ç—å—é.\n"
            "–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–¢–†–û–ì–û –≤ JSON (–±–µ–∑ markdown-–æ–±—ë—Ä—Ç–æ–∫, –±–µ–∑ ```json```):\n\n"
            '{\n'
            '  "title": "–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏ (–∏–∑–≤–ª–µ–∫–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –ø—Ä–∏–¥—É–º–∞–π —Ç–æ—á–Ω—ã–π)",\n'
            '  "category": "–û–î–ù–ê –∏–∑: News, Analytics, Guide, Legal Opinion, Media, Interview",\n'
            '  "categoryRu": "–†—É—Å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: –ù–æ–≤–æ—Å—Ç–∏, –ê–Ω–∞–ª–∏—Ç–∏–∫–∞, –ì–∞–π–¥ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞, –ú–Ω–µ–Ω–∏–µ –ü–∞—Ä—Ç–Ω–µ—Ä–∞, –°–ú–ò –æ –Ω–∞—Å, –ò–Ω—Ç–µ—Ä–≤—å—é",\n'
            '  "description": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–µ–≤—å—é (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤)",\n'
            '  "content": "–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ HTML: <h2>, <h3>, <p>, <ul>, <li>, <strong>, <em>, <blockquote>"\n'
            '}\n\n'
            "–ü–†–ê–í–ò–õ–ê –¥–ª—è content:\n"
            "- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π <h1>\n"
            "- –ù–ï –¥–æ–±–∞–≤–ª—è–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ content (–æ–Ω –≤ title)\n"
            "- –°–æ—Ö—Ä–∞–Ω–∏ –í–°–ï —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ —É–¥–∞–ª—è–π\n"
            "- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π: —Ä–∞–∑–±–µ–π –Ω–∞ —Ä–∞–∑–¥–µ–ª—ã —Å <h2>/<h3>\n"
            "- –°—Å—ã–ª–∫–∏ –Ω–∞ –∑–∞–∫–æ–Ω—ã: <strong>—Å—Ç. N –¢–ö –†–ö</strong>\n\n"
            "–í–ê–ñ–ù–û: –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON.\n\n"
            "–¢–ï–ö–°–¢ –°–¢–ê–¢–¨–ò:\n"
        )
    elif task == "channel_post":
        instruction = "–ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:\n"
    else:
        instruction = f"{task}\n\n"

    full_prompt = instruction + raw_text
    persona = CONTENT_PERSONA if task == "format_article" else CHANNEL_POST_PERSONA
    ai = get_orchestrator()

    return await ai.call_with_fallback(
        full_prompt, persona,
        primary="openai",
        max_tokens=max_tokens, temperature=0.5,
    )


async def ask_digest(
    prompt: str,
    *,
    context: str = "",
    max_tokens: int = 2048,
) -> str:
    """–£—Ç—Ä–µ–Ω–Ω–∏–π/–≤–µ—á–µ—Ä–Ω–∏–π –¥–∞–π–¥–∂–µ—Å—Ç –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (GPT -> fallback Gemini)."""
    ai = get_orchestrator()
    full = ""
    if context:
        full += f"–ö–û–ù–¢–ï–ö–°–¢:\n{context}\n\n"
    full += prompt

    return await ai.call_with_fallback(
        full, MARKETING_PERSONA,
        primary="openai",
        max_tokens=max_tokens, temperature=0.7,
    )


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  –ì–ï–ù–ï–†–ê–¶–ò–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô (DALL-E 3)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


async def generate_image_prompt(topic: str) -> str:
    """AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è DALL-E –≤ —Ñ–∏—Ä–º–µ–Ω–Ω–æ–º —Å—Ç–∏–ª–µ SOLIS Partners."""
    ai = get_orchestrator()
    result = await ai.call_with_fallback(
        prompt=(
            f"–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø—Ä–æ–º–ø—Ç –¥–ª—è DALL-E 3 –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ.\n"
            f"–¢–µ–º–∞: {topic}\n\n"
            "–°—Ç–∏–ª—å: –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è.\n"
            "–ü–∞–ª–∏—Ç—Ä–∞: —Ç—ë–º–Ω–æ-—Å–∏–Ω–∏–π (#1a237e), –∑–æ–ª–æ—Ç–æ–π (#c9a227), –±–µ–ª—ã–π.\n"
            "–≠–ª–µ–º–µ–Ω—Ç—ã: –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—ã, –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã.\n"
            "–ë–ï–ó —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏. –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ 16:9.\n"
            "–£—Ä–æ–≤–µ–Ω—å: –æ–±–ª–æ–∂–∫–∞ –¥–ª—è Forbes –∏–ª–∏ Harvard Business Review.\n\n"
            "–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –ø—Ä–æ–º–ø—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, –Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ."
        ),
        system="–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–æ–º–ø—Ç–∞–º –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.",
        primary="openai", max_tokens=256, temperature=0.7,
    )
    return result.strip()


async def generate_post_image(topic: str, *, size: str = "1792x1024") -> str | None:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ DALL-E 3 –≤ —Å—Ç–∏–ª–µ SOLIS Partners.

    Args:
        topic: –¢–µ–º–∞/–∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
        size: –†–∞–∑–º–µ—Ä (1024x1024, 1792x1024, 1024x1792).

    Returns:
        URL —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ.
    """
    if not settings.OPENAI_API_KEY:
        logger.warning("DALL-E: OPENAI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
        return None

    try:
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç —á–µ—Ä–µ–∑ AI
        try:
            dalle_prompt = await generate_image_prompt(topic)
        except Exception:
            dalle_prompt = (
                f"Minimalist professional legal illustration about {topic}. "
                "Style: sleek corporate, geometric, deep blue and gold accents, "
                "high-end law firm aesthetic, no text, 16:9 aspect ratio."
            )

        ai = get_orchestrator()
        session = await ai._get_session()

        payload = {
            "model": "dall-e-3",
            "prompt": dalle_prompt,
            "size": size,
            "quality": "standard",
            "n": 1,
        }
        headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {settings.OPENAI_API_KEY}",
        }

        async with session.post(OPENAI_IMAGES_URL, json=payload, headers=headers) as resp:
            if resp.status != 200:
                error = await resp.text()
                logger.error("DALL-E error %d: %s", resp.status, error[:300])
                return None
            data = await resp.json()

        url = data.get("data", [{}])[0].get("url")
        logger.info("DALL-E image generated for: %s", topic[:50])
        return url

    except Exception as e:
        logger.error("DALL-E generation failed: %s", e)
        return None


async def analyze_legal_document(text: str, user_question: str = "") -> str:
    """L1: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ –Ω–∞ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏ (–¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤ doc_review)."""
    from src.bot.utils.doc_review import analyze_legal_document as _review
    return await _review(text, user_question)


async def multi_agent_brainstorm(question: str, context: str = "") -> str:
    """L5: –ú—É–ª—å—Ç–∏-–∞–≥–µ–Ω—Ç–Ω—ã–π –∫–æ–Ω—Å–∏–ª–∏—É–º (–¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤ multi_agent)."""
    from src.bot.utils.multi_agent import multi_agent_brainstorm as _brainstorm
    return await _brainstorm(question, context)


async def audit_post_beauty(text: str) -> dict:
    """AI-–∞—É–¥–∏—Ç ¬´–∫—Ä–∞—Å–æ—Ç—ã¬ª —Ç–µ–∫—Å—Ç–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - –ü–ª–æ—Ç–Ω–æ—Å—Ç—å —ç–º–æ–¥–∑–∏ (–Ω–µ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ/–º–∞–ª–æ)
    - –ù–∞–ª–∏—á–∏–µ –∞–±–∑–∞—Ü–µ–≤ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    - –î–ª–∏–Ω—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
    - –ë–∞–ª–∞–Ω—Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

    Returns:
        {"passed": bool, "score": int, "issues": [...], "suggestion": str}
    """
    ai = get_orchestrator()
    audit_prompt = (
        f"–ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è Telegram:\n\n"
        f"---\n{text[:2000]}\n---\n\n"
        "–û—Ü–µ–Ω–∏ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º (0-10 –∫–∞–∂–¥—ã–π):\n"
        "1. emoji_density: –Ω–µ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ (>15 ‚Äî –ø–ª–æ—Ö–æ), –Ω–µ —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ (<2 ‚Äî –ø–ª–æ—Ö–æ)\n"
        "2. paragraph_structure: –µ—Å—Ç—å –ª–∏ –∞–±–∑–∞—Ü—ã, –æ—Ç—Å—Ç—É–ø—ã, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏\n"
        "3. readability: –Ω–µ ¬´–ø—Ä–æ—Å—Ç—ã–Ω—è¬ª, –∫–æ—Ä–æ—Ç–∫–∏–µ –±–ª–æ–∫–∏ —Ç–µ–∫—Å—Ç–∞ (2-3 —Å—Ç—Ä–æ–∫–∏)\n"
        "4. formatting: –µ—Å—Ç—å –∂–∏—Ä–Ω—ã–π, –∫—É—Ä—Å–∏–≤, —Å–ø–∏—Å–∫–∏ –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ\n"
        "5. cta_presence: –µ—Å—Ç—å –ª–∏ –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é\n\n"
        "–í–µ—Ä–Ω–∏ –°–¢–†–û–ì–û JSON:\n"
        '{"passed": true/false, "score": –æ–±—â–∏–π_0_50, '
        '"issues": ["–ø—Ä–æ–±–ª–µ–º–∞1", ...], '
        '"suggestion": "—á—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å"}'
    )

    try:
        result = await ai.call_with_fallback(
            audit_prompt,
            "–¢—ã ‚Äî UX-—Ä–µ–¥–∞–∫—Ç–æ—Ä Telegram-–∫–∞–Ω–∞–ª–∞. –û—Ü–µ–Ω–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ç–µ–∫—Å—Ç–∞.",
            primary="openai", max_tokens=512, temperature=0.3,
        )

        import re
        match = re.search(r'\{.*\}', result, re.DOTALL)
        if match:
            return json.loads(match.group())
    except Exception as e:
        logger.warning("Beauty audit failed: %s", e)

    return {"passed": True, "score": 25, "issues": [], "suggestion": ""}
