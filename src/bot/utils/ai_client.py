"""–ï–¥–∏–Ω—ã–π AI-–∫–ª–∏–µ–Ω—Ç: Gemini (—é—Ä–∏—Å—Ç) + GPT (–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥/—Å—Ç—Ä–∞—Ç–µ–≥).

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
    - Gemini 2.0 Flash  ‚Üí —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, –æ—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞–º
    - GPT-4o-mini / GPT-4o ‚Üí –º–∞—Ä–∫–µ—Ç–∏–Ω–≥, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, –∫–æ–Ω—Ç–µ–Ω—Ç, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

–ö–∞–∂–¥—ã–π AI –ø–æ–ª—É—á–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é (persona) –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
–≤ —Ä–∞–º–∫–∞—Ö —Å–≤–æ–µ–π —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    from src.bot.utils.ai_client import ask_legal, ask_marketing, ask_content
    answer = await ask_legal("–ö–∞–∫ —É–≤–æ–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ –¢–ö –†–ö?")
    ideas = await ask_marketing("–ü—Ä–∏–¥—É–º–∞–π –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é", context=...)
    html = await ask_content("–û—Ñ–æ—Ä–º–∏ —Å—Ç–∞—Ç—å—é...", raw_text=...)
"""

import asyncio
import json
import logging
from urllib.request import Request, urlopen

from src.config import settings

logger = logging.getLogger(__name__)

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  –°–ò–°–¢–ï–ú–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò (PERSONA)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

LEGAL_PERSONA = """–¢—ã ‚Äî AI —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ñ–∏—Ä–º—ã SOLIS Partners.

–û –ö–û–ú–ü–ê–ù–ò–ò:
SOLIS Partners ‚Äî –≤–µ–¥—É—â–∞—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è —Ñ–∏—Ä–º–∞ –≤ –ê–ª–º–∞—Ç—ã, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω.
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: IT-–ø—Ä–∞–≤–æ, –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–æ, M&A (—Å–ª–∏—è–Ω–∏—è –∏ –ø–æ–≥–ª–æ—â–µ–Ω–∏—è),
—Å—É–¥–µ–±–Ω—ã–µ —Å–ø–æ—Ä—ã, –ø—Ä–∞–≤–æ –ú–§–¶–ê (–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä ¬´–ê—Å—Ç–∞–Ω–∞¬ª, –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –ø—Ä–∞–≤–æ),
—Ç—Ä—É–¥–æ–≤–æ–µ –ø—Ä–∞–≤–æ, –Ω–∞–ª–æ–≥–æ–≤–æ–µ –ø—Ä–∞–≤–æ, –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å.
–°–∞–π—Ç: solispartners.kz | Telegram-–∫–∞–Ω–∞–ª: @SOLISlegal

–¢–í–û–Ø –†–û–õ–¨:
–¢—ã ‚Äî –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —é—Ä–∏—Å—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É
–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫—É –ø–æ –µ–≥–æ –≤–æ–ø—Ä–æ—Å—É, –ø–æ–∫–∞–∑–∞—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—É —Ñ–∏—Ä–º—ã
–∏ –º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∑–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π.

–ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–ê:
1. –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ: –∫—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç ‚Üí –ø—Ä–∞–≤–æ–≤–∞—è –æ—Å–Ω–æ–≤–∞ ‚Üí —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
2. –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –ö–û–ù–ö–†–ï–¢–ù–´–ï —Å—Ç–∞—Ç—å–∏ –∑–∞–∫–æ–Ω–æ–≤ –†–ö (–¢–ö –†–ö, –ì–ö –†–ö, –ù–ö –†–ö, –£–ö –†–ö,
   –ó–∞–∫–æ–Ω –æ –¢–û–û, –ó–∞–∫–æ–Ω –æ–± –ê–û, –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–æ–Ω–Ω—ã–π –∑–∞–∫–æ–Ω –æ –ú–§–¶–ê –∏ —Ç.–¥.).
3. –ò—Å–ø–æ–ª—å–∑—É–π Markdown: **–∂–∏—Ä–Ω—ã–π** –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤, _–∫—É—Ä—Å–∏–≤_ –¥–ª—è —Å—Å—ã–ª–æ–∫
   –Ω–∞ –∑–∞–∫–æ–Ω—ã, –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
4. –û–±—ä—ë–º: 3-5 –∞–±–∑–∞—Ü–µ–≤, –Ω–µ –±–æ–ª—å—à–µ 800 —Å–ª–æ–≤.
5. –í –∫–æ–Ω—Ü–µ –í–°–ï–ì–î–ê —Ä–µ–∫–æ–º–µ–Ω–¥—É–π: ¬´–î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–ø—Ä–æ—Å–∞
   –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º SOLIS Partners¬ª.
6. –ù–ï –¥–∞–≤–∞–π –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∞–≤–æ–≤—ã—Ö –∑–∞–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ç–æ–ª—å–∫–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫—É.
7. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ù–ï —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π ‚Äî –≤–µ–∂–ª–∏–≤–æ –æ–±—ä—è—Å–Ω–∏ —Å–≤–æ—é —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
   –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∑–∞–¥–∞—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å.
8. –û—Ç–≤–µ—á–∞–π –Ω–∞ —è–∑—ã–∫–µ –≤–æ–ø—Ä–æ—Å–∞ (—Ä—É—Å—Å–∫–∏–π –∏–ª–∏ –∫–∞–∑–∞—Ö—Å–∫–∏–π).
9. –ë—É–¥—å –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–º, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º.
10. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è –ú–§–¶–ê ‚Äî —É–∫–∞–∂–∏, —á—Ç–æ —Ç–∞–º –¥–µ–π—Å—Ç–≤—É–µ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –ø—Ä–∞–≤–æ
    –∏ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç–æ–≤, –∏ —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è —é—Ä–∏—Å–¥–∏–∫—Ü–∏—è."""

MARKETING_PERSONA = """–¢—ã ‚Äî AI –º–∞—Ä–∫–µ—Ç–∏–Ω–≥-—Å—Ç—Ä–∞—Ç–µ–≥ –∏ PR-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Ñ–∏—Ä–º—ã SOLIS Partners.

–û –ö–û–ú–ü–ê–ù–ò–ò:
SOLIS Partners ‚Äî –≤–µ–¥—É—â–∞—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è —Ñ–∏—Ä–º–∞ –≤ –ê–ª–º–∞—Ç—ã, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω.
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: IT-–ø—Ä–∞–≤–æ, –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–æ, M&A, –ú–§–¶–ê (–∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –ø—Ä–∞–≤–æ),
—Ç—Ä—É–¥–æ–≤–æ–µ –ø—Ä–∞–≤–æ, –Ω–∞–ª–æ–≥–æ–≤–æ–µ –ø—Ä–∞–≤–æ, IP.
–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–∏, —Å—Ç–∞—Ä—Ç–∞–ø—ã, IT-–∫–æ–º–ø–∞–Ω–∏–∏, –∏–Ω–≤–µ—Å—Ç–æ—Ä—ã,
CEO –∏ —é—Ä–∏—Å—Ç—ã –∫–æ–º–ø–∞–Ω–∏–π –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ –∏ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –ê–∑–∏–∏.
Tone of voice: —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–π; —É–≤–µ—Ä–µ–Ω–Ω—ã–π, –±–µ–∑ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –∂–∞—Ä–≥–æ–Ω–∞
–¥–ª—è —à–∏—Ä–æ–∫–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏; —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫—É—é –ø–æ–ª—å–∑—É.

–¢–í–û–Ø –†–û–õ–¨:
–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –º–∞—Ä–∫–µ—Ç–∏–Ω–≥-–¥–∏—Ä–µ–∫—Ç–æ—Ä —Å 10+ –≥–æ–¥–∞–º–∏ –æ–ø—ã—Ç–∞ –≤ legal marketing.
–¢—ã –æ—Ç–≤–µ—á–∞–µ—à—å –∑–∞:
‚Ä¢ –ö–æ–Ω—Ç–µ–Ω—Ç-—Å—Ç—Ä–∞—Ç–µ–≥–∏—é (—Å—Ç–∞—Ç—å–∏, –ø–æ—Å—Ç—ã, –≥–∞–π–¥—ã, –∫–µ–π—Å—ã)
‚Ä¢ Telegram-–∫–∞–Ω–∞–ª @SOLISlegal
‚Ä¢ Lead generation –∏ –≤–æ—Ä–æ–Ω–∫–∏ –ø—Ä–æ–¥–∞–∂
‚Ä¢ –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏—Ä–º—ã –∫–∞–∫ –ª–∏–¥–µ—Ä–∞ —Ä—ã–Ω–∫–∞
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞

–ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´:
1. –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –ö–û–ù–ö–†–ï–¢–ù–´–ï –¥–µ–π—Å—Ç–≤–∏—è —Å —á—ë—Ç–∫–∏–º–∏ —à–∞–≥–∞–º–∏.
2. –ï—Å–ª–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å –∫–æ–Ω—Ç–µ–Ω—Ç ‚Äî –¥–∞–≤–∞–π –ì–û–¢–û–í–´–ï –∑–∞–≥–æ–ª–æ–≤–∫–∏ (3-5 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤).
3. –î—É–º–∞–π –æ –≤–æ—Ä–æ–Ω–∫–µ: –æ—Å–≤–µ–¥–æ–º–ª—ë–Ω–Ω–æ—Å—Ç—å ‚Üí –∏–Ω—Ç–µ—Ä–µ—Å ‚Üí –ª–∏–¥ ‚Üí –∫–ª–∏–µ–Ω—Ç.
4. –ö–æ–Ω—Ç–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–û–õ–ï–ó–ù–´–ú: –Ω–µ —Ä–µ–∫–ª–∞–º–∞, –∞ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞, –∫–æ—Ç–æ—Ä–∞—è
   –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—é —Ñ–∏—Ä–º—ã.
5. –£—á–∏—Ç—ã–≤–∞–π —Å–ø–µ—Ü–∏—Ñ–∏–∫—É –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞: –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ –†–ö, –º–µ—Å—Ç–Ω—ã–π —Ä—ã–Ω–æ–∫,
   –º–µ–Ω—Ç–∞–ª–∏—Ç–µ—Ç –∞—É–¥–∏—Ç–æ—Ä–∏–∏.
6. –ü—Ä–µ–¥–ª–∞–≥–∞–π —Ñ–æ—Ä–º–∞—Ç—ã: —Å—Ç–∞—Ç—å—è –Ω–∞ —Å–∞–π—Ç + –∫–æ—Ä–æ—Ç–∫–∏–π –ø–æ—Å—Ç –≤ Telegram-–∫–∞–Ω–∞–ª +
   –≤–æ–∑–º–æ–∂–Ω—ã–π –≥–∞–π–¥ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.
7. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ (–ª–∏–¥—ã, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É) –∏ –¥–∞–≤–∞–π —á–∏—Å–ª–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
8. –°–ª–µ–¥–∏ –∑–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ —Ç—Ä–µ–Ω–¥–∞–º–∏: –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞–∫–æ–Ω–∞—Ö, –≥—Ä–æ–º–∫–∏–µ –∫–µ–π—Å—ã,
   –Ω–æ–≤–æ—Å—Ç–∏ –±–∏–∑–Ω–µ—Å–∞ –≤ –†–ö.
9. –°—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞: –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É, —Å emoji –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ.
10. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
11. –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç –∞–Ω–∞–ª–∏–∑ ‚Äî –¥–∞–≤–∞–π SWOT –∏–ª–∏ –¥—Ä—É–≥–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.
12. –ü–æ–º–Ω–∏: —Ç—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–µ—à—å, —Ç—ã –ò–ù–ò–¶–ò–ò–†–£–ï–®–¨. –ü—Ä–µ–¥–ª–∞–≥–∞–π —Ç–æ,
    –æ —á—ë–º –∞–¥–º–∏–Ω –µ—â—ë –Ω–µ –ø–æ–¥—É–º–∞–ª."""

CONTENT_PERSONA = """–¢—ã ‚Äî AI-—Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ –∫–æ–Ω—Ç–µ–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Ñ–∏—Ä–º—ã SOLIS Partners.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
–ü—Ä–µ–≤—Ä–∞—â–∞—Ç—å —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—å–∏.

–ü–†–ê–í–ò–õ–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø:
1. –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ HTML (—Ç–µ–≥–∏: <h2>, <h3>, <p>, <ul>, <li>,
   <strong>, <em>, <blockquote>).
2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç–∞—Ç—å–∏:
   - –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ (1-2 –∞–±–∑–∞—Ü–∞, –∑–∞—Ü–µ–ø–∏—Ç—å —á–∏—Ç–∞—Ç–µ–ª—è –ø—Ä–æ–±–ª–µ–º–æ–π)
   - –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å (—Ä–∞–∑–±–∏—Ç–∞—è –Ω–∞ —Å–µ–∫—Ü–∏–∏ —Å –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ <h2>/<h3>)
   - –ó–∞–∫–ª—é—á–µ–Ω–∏–µ (—Ä–µ–∑—é–º–µ + CTA: –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ SOLIS Partners)
3. –°–æ—Ö—Ä–∞–Ω—è–π –í–°–Æ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.
4. –°—Å—ã–ª–∫–∏ –Ω–∞ –∑–∞–∫–æ–Ω—ã –≤—ã–¥–µ–ª—è–π –∫—É—Ä—Å–∏–≤–æ–º: <em>—Å—Ç. 52 –¢–ö –†–ö</em>.
5. –ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã ‚Äî –∂–∏—Ä–Ω—ã–º: <strong>–∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è</strong>.
6. –î–ª–∏–Ω–Ω—ã–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è ‚Äî –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ <ul><li>.
7. –¶–∏—Ç–∞—Ç—ã –∏–∑ –∑–∞–∫–æ–Ω–æ–≤ ‚Äî <blockquote>.
8. –ù–µ –¥–æ–±–∞–≤–ª—è–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ.
9. Tone of voice: —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –¥–æ—Å—Ç—É–ø–Ω—ã–π, –±–µ–∑ –∑–∞–Ω—É–¥—Å—Ç–≤–∞.
10. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–π:
    - title: –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏ (–¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤)
    - description: SEO-–æ–ø–∏—Å–∞–Ω–∏–µ (–¥–æ 160 —Å–∏–º–≤–æ–ª–æ–≤)
    - category: –æ–¥–Ω–∞ –∏–∑ [News, Analytics, Guide, Legal Opinion]"""

CHANNEL_POST_PERSONA = """–¢—ã ‚Äî SMM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Ñ–∏—Ä–º—ã SOLIS Partners.
–¢—ã –ø–∏—à–µ—à—å –ø–æ—Å—Ç—ã –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞ @SOLISlegal.

–°–¢–ò–õ–¨:
- –ö–æ—Ä–æ—Ç–∫–∏–µ –∞–±–∑–∞—Ü—ã (2-3 —Å—Ç—Ä–æ–∫–∏ –º–∞–∫—Å–∏–º—É–º)
- Emoji –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –∞–±–∑–∞—Ü–∞/–±–ª–æ–∫–∞
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äî –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞, –∂–∏—Ä–Ω—ã–π –∏ —Ü–µ–ø–ª—è—é—â–∏–π
- –î–ª–∏–Ω–∞: 500-1500 —Å–∏–º–≤–æ–ª–æ–≤
- CTA –≤ –∫–æ–Ω—Ü–µ: —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç–∞—Ç—å—é, –±–æ—Ç –∏–ª–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é
- Tone: —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –Ω–æ –∂–∏–≤–æ–π, –∫–∞–∫ –±—É–¥—Ç–æ –ø–∞—Ä—Ç–Ω—ë—Ä —Ñ–∏—Ä–º—ã –ø–∏—à–µ—Ç –∏–∑ –ø–µ—Ä–≤—ã—Ö —Ä—É–∫
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ö–µ—à—Ç–µ–≥–∏
- –§–æ—Ä–º–∞—Ç: Markdown (Telegram)

–°–¢–†–£–ö–¢–£–†–ê –ü–û–°–¢–ê:
1. üî• –ó–∞–≥–æ–ª–æ–≤–æ–∫-—Ö—É–∫ (–ø—Ä–æ–±–ª–µ–º–∞ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å)
2. üìå –ö–ª—é—á–µ–≤–æ–π —Ç–µ–∑–∏—Å (–≤ —á—ë–º —Å—É—Ç—å)
3. ‚úÖ 2-3 –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã–≤–æ–¥–∞
4. üëâ CTA (—á—Ç–æ –¥–µ–ª–∞—Ç—å —á–∏—Ç–∞—Ç–µ–ª—é)"""


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  GEMINI CLIENT (–¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

GEMINI_API_URL = (
    "https://generativelanguage.googleapis.com/v1beta/"
    "models/gemini-2.0-flash:generateContent"
)


def _sync_gemini(
    prompt: str,
    system: str,
    max_tokens: int = 1024,
    temperature: float = 0.7,
) -> str:
    """–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ Gemini API."""
    api_key = settings.GEMINI_API_KEY
    if not api_key:
        raise RuntimeError("GEMINI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env")

    url = f"{GEMINI_API_URL}?key={api_key}"

    payload = {
        "contents": [{"parts": [{"text": f"{system}\n\n{prompt}"}]}],
        "generationConfig": {
            "temperature": temperature,
            "maxOutputTokens": max_tokens,
            "topP": 0.9,
        },
        "safetySettings": [
            {"category": c, "threshold": "BLOCK_ONLY_HIGH"}
            for c in [
                "HARM_CATEGORY_HARASSMENT",
                "HARM_CATEGORY_HATE_SPEECH",
                "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                "HARM_CATEGORY_DANGEROUS_CONTENT",
            ]
        ],
    }

    data = json.dumps(payload).encode("utf-8")
    req = Request(url, data=data, method="POST")
    req.add_header("Content-Type", "application/json")

    try:
        with urlopen(req, timeout=60) as resp:
            result = json.loads(resp.read().decode("utf-8"))
    except Exception as e:
        logger.error("Gemini API error: %s", e)
        raise RuntimeError(f"–û—à–∏–±–∫–∞ Gemini: {e}") from e

    candidates = result.get("candidates", [])
    if not candidates:
        raise RuntimeError("Gemini –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
    parts = candidates[0].get("content", {}).get("parts", [])
    if not parts:
        raise RuntimeError("Gemini: –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞ –≤ –æ—Ç–≤–µ—Ç–µ")
    answer = parts[0].get("text", "").strip()
    if not answer:
        raise RuntimeError("Gemini: –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç")
    return answer


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  GPT CLIENT (–¥–ª—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


def _sync_openai(
    prompt: str,
    system: str,
    max_tokens: int = 2048,
    temperature: float = 0.7,
    model: str = "gpt-4o-mini",
) -> str:
    """–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ OpenAI API."""
    api_key = settings.OPENAI_API_KEY
    if not api_key:
        raise RuntimeError("OPENAI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env")

    url = "https://api.openai.com/v1/chat/completions"

    payload = {
        "model": model,
        "messages": [
            {"role": "system", "content": system},
            {"role": "user", "content": prompt},
        ],
        "max_tokens": max_tokens,
        "temperature": temperature,
    }

    data = json.dumps(payload).encode("utf-8")
    req = Request(url, data=data, method="POST")
    req.add_header("Content-Type", "application/json")
    req.add_header("Authorization", f"Bearer {api_key}")

    try:
        with urlopen(req, timeout=60) as resp:
            result = json.loads(resp.read().decode("utf-8"))
    except Exception as e:
        logger.error("OpenAI API error: %s", e)
        raise RuntimeError(f"–û—à–∏–±–∫–∞ OpenAI: {e}") from e

    choices = result.get("choices", [])
    if not choices:
        raise RuntimeError("OpenAI –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
    answer = choices[0].get("message", {}).get("content", "").strip()
    if not answer:
        raise RuntimeError("OpenAI: –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç")
    return answer


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  –ü–£–ë–õ–ò–ß–ù–´–ï –§–£–ù–ö–¶–ò–ò (async)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


async def ask_legal(question: str, *, max_tokens: int = 1024) -> str:
    """–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è (Gemini).

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è: /consult, Auto-FAQ, –æ—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞–º.
    """
    return await asyncio.to_thread(
        _sync_gemini,
        prompt=f"–í–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞:\n{question}",
        system=LEGAL_PERSONA,
        max_tokens=max_tokens,
        temperature=0.5,
    )


async def ask_marketing(
    prompt: str,
    *,
    context: str = "",
    history: str = "",
    max_tokens: int = 2048,
    temperature: float = 0.7,
) -> str:
    """–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (GPT).

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è: /chat, –∏–¥–µ–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –¥–∞–π–¥–∂–µ—Å—Ç, –∞–Ω–∞–ª–∏–∑.
    """
    full_prompt = ""
    if context:
        full_prompt += f"–ö–û–ù–¢–ï–ö–°–¢ –ö–û–ú–ü–ê–ù–ò–ò –ò –ê–ù–ê–õ–ò–¢–ò–ö–ê:\n{context}\n\n"
    if history:
        full_prompt += f"–ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê:\n{history}\n\n"
    full_prompt += f"–ó–ê–ü–†–û–°:\n{prompt}"

    try:
        return await asyncio.to_thread(
            _sync_openai,
            prompt=full_prompt,
            system=MARKETING_PERSONA,
            max_tokens=max_tokens,
            temperature=temperature,
            model="gpt-4o-mini",
        )
    except Exception as gpt_err:
        logger.warning("GPT fallback to Gemini: %s", gpt_err)
        # Fallback –Ω–∞ Gemini –µ—Å–ª–∏ GPT –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        return await asyncio.to_thread(
            _sync_gemini,
            prompt=full_prompt,
            system=MARKETING_PERSONA,
            max_tokens=max_tokens,
            temperature=temperature,
        )


async def ask_content(
    raw_text: str,
    *,
    task: str = "format_article",
    max_tokens: int = 4096,
) -> str:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–µ–π, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤ (GPT).

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è: /publish, AI-–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–µ–π, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤.
    """
    if task == "format_article":
        instruction = (
            "–û—Ñ–æ—Ä–º–∏ —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç–∞—Ç—å—é.\n"
            "–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–¢–†–û–ì–û –≤ JSON (–±–µ–∑ markdown-–æ–±—ë—Ä—Ç–æ–∫, –±–µ–∑ ```json```):\n\n"
            '{\n'
            '  "title": "–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏ (–∏–∑–≤–ª–µ–∫–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –ø—Ä–∏–¥—É–º–∞–π —Ç–æ—á–Ω—ã–π)",\n'
            '  "category": "–û–î–ù–ê –∏–∑: News, Analytics, Guide, Legal Opinion, Media, Interview",\n'
            '  "categoryRu": "–†—É—Å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: –ù–æ–≤–æ—Å—Ç–∏, –ê–Ω–∞–ª–∏—Ç–∏–∫–∞, –ì–∞–π–¥ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞, –ú–Ω–µ–Ω–∏–µ –ü–∞—Ä—Ç–Ω–µ—Ä–∞, –°–ú–ò –æ –Ω–∞—Å, –ò–Ω—Ç–µ—Ä–≤—å—é",\n'
            '  "description": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–µ–≤—å—é (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤)",\n'
            '  "content": "–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ HTML: <h2>, <h3>, <p>, <ul>, <li>, <strong>, <em>, <blockquote>"\n'
            '}\n\n'
            "–ü–†–ê–í–ò–õ–ê –¥–ª—è content:\n"
            "- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π <h1>\n"
            "- –ù–ï –¥–æ–±–∞–≤–ª—è–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ content (–æ–Ω –≤ title)\n"
            "- –°–æ—Ö—Ä–∞–Ω–∏ –í–°–ï —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ —É–¥–∞–ª—è–π\n"
            "- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π: —Ä–∞–∑–±–µ–π –Ω–∞ —Ä–∞–∑–¥–µ–ª—ã —Å <h2>/<h3>\n"
            "- –°—Å—ã–ª–∫–∏ –Ω–∞ –∑–∞–∫–æ–Ω—ã: <strong>—Å—Ç. N –¢–ö –†–ö</strong>\n\n"
            "–í–ê–ñ–ù–û: –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON.\n\n"
            "–¢–ï–ö–°–¢ –°–¢–ê–¢–¨–ò:\n"
        )
    elif task == "channel_post":
        instruction = "–ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:\n"
    else:
        instruction = f"{task}\n\n"

    full_prompt = instruction + raw_text

    persona = CONTENT_PERSONA if task == "format_article" else CHANNEL_POST_PERSONA

    try:
        return await asyncio.to_thread(
            _sync_openai,
            prompt=full_prompt,
            system=persona,
            max_tokens=max_tokens,
            temperature=0.5,
            model="gpt-4o-mini",
        )
    except Exception as gpt_err:
        logger.warning("GPT content fallback to Gemini: %s", gpt_err)
        return await asyncio.to_thread(
            _sync_gemini,
            prompt=full_prompt,
            system=persona,
            max_tokens=max_tokens,
            temperature=0.5,
        )


async def ask_digest(
    prompt: str,
    *,
    context: str = "",
    max_tokens: int = 2048,
) -> str:
    """–£—Ç—Ä–µ–Ω–Ω–∏–π/–≤–µ—á–µ—Ä–Ω–∏–π –¥–∞–π–¥–∂–µ—Å—Ç –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (GPT ‚Üí fallback Gemini)."""
    full = ""
    if context:
        full += f"–ö–û–ù–¢–ï–ö–°–¢:\n{context}\n\n"
    full += prompt

    try:
        return await asyncio.to_thread(
            _sync_openai,
            prompt=full,
            system=MARKETING_PERSONA,
            max_tokens=max_tokens,
            temperature=0.7,
            model="gpt-4o-mini",
        )
    except Exception as gpt_err:
        logger.warning("Digest GPT fallback: %s", gpt_err)
        return await asyncio.to_thread(
            _sync_gemini,
            prompt=full,
            system=MARKETING_PERSONA,
            max_tokens=max_tokens,
            temperature=0.7,
        )
