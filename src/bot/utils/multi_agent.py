"""L5. –ú—É–ª—å—Ç–∏-–∞–≥–µ–Ω—Ç–Ω—ã–π –∫–æ–Ω—Å–∏–ª–∏—É–º (Legal Brainstorm).

–î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –∑–∞–ø—É—Å–∫–∞–µ—Ç ¬´—Å–ø–æ—Ä¬ª –º–µ–∂–¥—É —Ç—Ä–µ–º—è AI-–∞–≥–µ–Ω—Ç–∞–º–∏:
- –Æ—Ä–∏—Å—Ç –ø–æ –ú–§–¶–ê (–∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –ø—Ä–∞–≤–æ)
- –ù–∞–ª–æ–≥–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (–ù–ö –†–ö)
- –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π/—Å—É–¥–µ–±–Ω—ã–π —Å—Ç—Ä–∞—Ç–µ–≥

–†–µ–∑—É–ª—å—Ç–∞—Ç: –≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Ä–µ–∑—é–º–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    from src.bot.utils.multi_agent import multi_agent_brainstorm
    result = await multi_agent_brainstorm("–ö–∞–∫ –æ—Ç–∫—Ä—ã—Ç—å IT-–∫–æ–º–ø–∞–Ω–∏—é –≤ –ú–§–¶–ê?")
"""

import asyncio
import logging

logger = logging.getLogger(__name__)

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  –ê–ì–ï–ù–¢–´ ‚Äî –ø–µ—Ä—Å–æ–Ω—ã –¥–ª—è –º—É–ª—å—Ç–∏-–∞–≥–µ–Ω—Ç–Ω–æ–≥–æ –æ–±—Å—É–∂–¥–µ–Ω–∏—è
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

AGENTS = {
    "aifc_lawyer": {
        "name": "‚öñÔ∏è –Æ—Ä–∏—Å—Ç –ø–æ –ú–§–¶–ê",
        "persona": (
            "–¢—ã ‚Äî —Å—Ç–∞—Ä—à–∏–π —é—Ä–∏—Å—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –ø—Ä–∞–≤–µ –ú–§–¶–ê (–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π "
            "—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä ¬´–ê—Å—Ç–∞–Ω–∞¬ª). –¢—ã –∑–Ω–∞–µ—à—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –æ–±—â–µ–µ –ø—Ä–∞–≤–æ, AIFC Regulations, "
            "Companies Regulations 2017, Employment Framework. –ö–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å "
            "—Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ú–§–¶–ê –∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω: —É–∫–∞–∑—ã–≤–∞–π "
            "–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –∞–∫—Ç—ã –ú–§–¶–ê. –û—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º, HTML –¥–ª—è Telegram, 150-250 —Å–ª–æ–≤."
        ),
    },
    "tax_consultant": {
        "name": "üí∞ –ù–∞–ª–æ–≥–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç",
        "persona": (
            "–¢—ã ‚Äî –Ω–∞–ª–æ–≥–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É –†–µ—Å–ø—É–±–ª–∏–∫–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω. "
            "–¢—ã –∑–Ω–∞–µ—à—å –ù–∞–ª–æ–≥–æ–≤—ã–π –∫–æ–¥–µ–∫—Å –†–ö –Ω–∞–∏–∑—É—Å—Ç—å. –ö–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å —Å —Ç–æ—á–∫–∏ "
            "–∑—Ä–µ–Ω–∏—è –Ω–∞–ª–æ–≥–æ–≤—ã—Ö –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π: –ö–ü–ù, –ò–ü–ù, –ù–î–°, —Å–æ—Ü–∏–∞–ª—å–Ω—ã–π –Ω–∞–ª–æ–≥, "
            "—Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—Ç–Ω–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –Ω–∞–ª–æ–≥–æ–≤—ã–µ –ª—å–≥–æ—Ç—ã (–°–≠–ó, –ú–§–¶–ê, IT-–ø–∞—Ä–∫). "
            "–£–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –ù–ö –†–ö. –û—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º, HTML, 150-250 —Å–ª–æ–≤."
        ),
    },
    "corporate_strategist": {
        "name": "üèõÔ∏è –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å—Ç—Ä–∞—Ç–µ–≥",
        "persona": (
            "–¢—ã ‚Äî –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —é—Ä–∏—Å—Ç –∏ —Å—É–¥–µ–±–Ω—ã–π –∞–¥–≤–æ–∫–∞—Ç —Å 15-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ. "
            "–û—Ü–µ–Ω–∏–≤–∞–π –≤–æ–ø—Ä–æ—Å —Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Å—Ç–æ—Ä–æ–Ω—ã: –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ä–∏—Å–∫–∏, —Å—É–¥–µ–±–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞, "
            "—Ä–µ–≥—É–ª—è—Ç–æ—Ä–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, compliance. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Å–ø–æ—Ä—É ‚Äî "
            "–æ—Ü–µ–Ω–∏ —à–∞–Ω—Å—ã. –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –ì–ö –†–ö, –ó–∞–∫–æ–Ω –æ –¢–û–û, –ó–∞–∫–æ–Ω –æ–± –ê–û, —Å—É–¥–µ–±–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É. "
            "–û—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º, HTML, 150-250 —Å–ª–æ–≤."
        ),
    },
}


async def multi_agent_brainstorm(question: str, context: str = "") -> str:
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –º—É–ª—å—Ç–∏-–∞–≥–µ–Ω—Ç–Ω–æ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞.

    Args:
        question: –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞.
        context: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (Data Room, –∏—Å—Ç–æ—Ä–∏—è).

    Returns:
        HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Å—É–∂–¥–µ–Ω–∏—è.
    """
    from src.bot.utils.ai_client import get_orchestrator

    ai = get_orchestrator()
    full_q = question
    if context:
        full_q = f"–ö–û–ù–¢–ï–ö–°–¢:\n{context}\n\n–í–û–ü–†–û–°:\n{question}"

    # –®–∞–≥ 1: –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤
    async def _ask_agent(agent_id: str) -> tuple[str, str]:
        agent = AGENTS[agent_id]
        try:
            resp = await ai.call_with_fallback(
                full_q, agent["persona"],
                primary="openai", max_tokens=512, temperature=0.5,
            )
            return agent["name"], resp
        except Exception as e:
            logger.warning("Agent %s failed: %s", agent_id, e)
            return agent["name"], f"<i>(–∞–≥–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {e})</i>"

    tasks = [_ask_agent(aid) for aid in AGENTS]
    results = await asyncio.gather(*tasks, return_exceptions=True)

    # –°–æ–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç—ã
    discussion = []
    for r in results:
        if isinstance(r, Exception):
            continue
        name, resp = r
        discussion.append(f"<b>{name}:</b>\n{resp}")

    if not discussion:
        return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–Ω–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

    # –®–∞–≥ 2: AI-—Å–∏–Ω—Ç–µ–∑ ‚Äî —Å–≤–æ–¥–∏–º –º–Ω–µ–Ω–∏—è –≤ –µ–¥–∏–Ω—ã–π –≤—ã–≤–æ–¥
    synthesis_prompt = (
        f"–í–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: {question}\n\n"
        "–ú–Ω–µ–Ω–∏—è —Ç—Ä—ë—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤:\n\n"
        + "\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n".join(discussion)
        + "\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n"
        "–°–≤–µ–¥–∏ —ç—Ç–∏ –º–Ω–µ–Ω–∏—è –≤ –µ–¥–∏–Ω—ã–π –∫—Ä–∞—Ç–∫–∏–π —Å–æ–≤–µ—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ (3-5 –∞–±–∑–∞—Ü–µ–≤). "
        "–£–∫–∞–∂–∏ —Ç–æ—á–∫–∏ —Å–æ–≥–ª–∞—Å–∏—è –∏ —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏—è. "
        "–î–∞–π —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é: —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å –∏ –Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ. "
        "–§–æ—Ä–º–∞—Ç: HTML –¥–ª—è Telegram. –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –º–Ω–µ–Ω–∏—è ‚Äî —Å–∏–Ω—Ç–µ–∑–∏—Ä—É–π."
    )

    try:
        summary = await ai.call_with_fallback(
            synthesis_prompt,
            "–¢—ã ‚Äî —É–ø—Ä–∞–≤–ª—è—é—â–∏–π –ø–∞—Ä—Ç–Ω—ë—Ä —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Ñ–∏—Ä–º—ã. –°–∏–Ω—Ç–µ–∑–∏—Ä—É–π –º–Ω–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä—Ç–æ–≤.",
            primary="openai", max_tokens=1024, temperature=0.4,
        )
    except Exception as e:
        logger.error("Synthesis failed: %s", e)
        summary = "<i>–°–∏–Ω—Ç–µ–∑ –º–Ω–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</i>"

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç
    report = (
        "üß† <b>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Å–∏–ª–∏—É–º SOLIS Partners</b>\n\n"
        f"üìù <b>–í–æ–ø—Ä–æ—Å:</b> {question[:200]}\n\n"
        "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n"
    )
    for d in discussion:
        report += f"{d}\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n"

    report += (
        "üéØ <b>–ò–¢–û–ì–û–í–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:</b>\n\n"
        f"{summary}\n\n"
        "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        "‚öñÔ∏è <i>–î–∞–Ω–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ—Å–∏—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. "
        "–î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ SOLIS Partners.</i>"
    )

    return report


async def quick_brainstorm(question: str) -> str:
    """–ë—ã—Å—Ç—Ä—ã–π –±—Ä–µ–π–Ω—à—Ç–æ—Ä–º (—Ç–æ–ª—å–∫–æ 2 –∞–≥–µ–Ω—Ç–∞, –±–µ–∑ —Å–∏–Ω—Ç–µ–∑–∞)."""
    from src.bot.utils.ai_client import get_orchestrator

    ai = get_orchestrator()
    agents = ["aifc_lawyer", "corporate_strategist"]

    parts = []
    for aid in agents:
        agent = AGENTS[aid]
        try:
            resp = await ai.call_with_fallback(
                question, agent["persona"],
                primary="openai", max_tokens=400, temperature=0.5,
            )
            parts.append(f"<b>{agent['name']}:</b>\n{resp}")
        except Exception:
            pass

    return "\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n".join(parts) if parts else "–ê–≥–µ–Ω—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã."
