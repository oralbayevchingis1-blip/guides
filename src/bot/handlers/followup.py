"""–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤—Ç–æ-—Å–µ—Ä–∏–∏ follow-up —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≥–∞–π–¥–∞.

–¢–µ–∫—Å—Ç—ã —Å–µ—Ä–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ Google Sheets (–ª–∏—Å—Ç ¬´–ê–≤—Ç–æ-—Å–µ—Ä–∏—è¬ª).
–ï—Å–ª–∏ –ª–∏—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è fallback-—Ç–µ–∫—Å—Ç—ã.

–£–º–Ω–æ–µ —É–¥–µ—Ä–∂–∞–Ω–∏–µ (Churn Prevention):
- Step 1 (24—á): –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã –≥–∞–π–¥–∞
- Step 2 (3 –¥–Ω—è): –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∫–µ–π—Å + AI-–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å
- Step 3 (7 –¥–Ω–µ–π): –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –º–∏–Ω–∏-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏

AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–º—É –≥–∞–π–¥–∞ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å,
—á—Ç–æ–±—ã –≤–æ–≤–ª–µ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¥–∏–∞–ª–æ–≥.
"""

import logging

from aiogram import Bot
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup

from src.bot.utils.cache import TTLCache
from src.bot.utils.google_sheets import GoogleSheetsClient

logger = logging.getLogger(__name__)

# Fallback-—Ç–µ–∫—Å—Ç—ã –µ—Å–ª–∏ Google Sheets –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
FALLBACK_FOLLOWUP: dict[int, str] = {
    1: (
        "üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í—á–µ—Ä–∞ –≤—ã —Å–∫–∞—á–∞–ª–∏ –Ω–∞—à –≥–∞–π–¥.\n\n"
        "–£–¥–∞–ª–æ—Å—å –ª–∏ –Ω–∞—á–∞—Ç—å –∏–∑—É—á–µ–Ω–∏–µ? –ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã ‚Äî "
        "–º—ã –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å!\n\n"
        "üì© –î–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º: @SOLISlegal"
    ),
    2: (
        "üìä –ü—Ä–∏–≤–µ—Ç! –ü—Ä–æ—à–ª–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≥–∞–π–¥–∞.\n\n"
        "–•–æ—Ç–∏–º –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –∫–µ–π—Å–æ–º SOLIS Partners –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ. "
        "–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–µ–∑–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã!\n\n"
        "üìö –î—Ä—É–≥–∏–µ –≥–∞–π–¥—ã: /start"
    ),
    3: (
        "üéØ –î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ù–∞–¥–µ–µ–º—Å—è, –≥–∞–π–¥ –æ–∫–∞–∑–∞–ª—Å—è –ø–æ–ª–µ–∑–Ω—ã–º.\n\n"
        "–ú—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º <b>–±–µ—Å–ø–ª–∞—Ç–Ω—É—é –º–∏–Ω–∏-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</b> (15 –º–∏–Ω—É—Ç) "
        "–ø–æ —Ç–µ–º–µ –≥–∞–π–¥–∞ —Å –Ω–∞—à–∏–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.\n\n"
        "–î–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º: @SOLISlegal\n\n"
        "üìö –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏–µ –≥–∞–π–¥—ã: /start"
    ),
}

# –ú–∞–ø–ø–∏–Ω–≥ guide_id -> —Ç–µ–º–∞ –¥–ª—è AI-–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
_GUIDE_TOPICS: dict[str, str] = {
    "too": "—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¢–û–û –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ",
    "ip": "–æ—Ç–∫—Ä—ã—Ç–∏–µ –ò–ü –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ",
    "mfca": "—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ –≤ –ú–§–¶–ê (AIFC)",
    "esop": "–æ–ø—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã ESOP –¥–ª—è —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤",
    "taxes": "–Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏–µ –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ",
    "labor": "—Ç—Ä—É–¥–æ–≤–æ–µ –ø—Ä–∞–≤–æ –∏ –Ω–∞–π–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",
    "it_law": "IT-–ø—Ä–∞–≤–æ –∏ –∑–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö",
    "ma": "—Å–¥–µ–ª–∫–∏ M&A –∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–æ",
}


async def _generate_personalized_question(guide_id: str, step: int) -> str | None:
    """AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã –≥–∞–π–¥–∞.

    Returns:
        –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ.
    """
    topic = _GUIDE_TOPICS.get(guide_id, "")
    if not topic:
        # –ü–æ–ø—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å —Ç–µ–º—É –∏–∑ ID
        topic = guide_id.replace("_", " ").replace("-", " ")

    try:
        from src.bot.utils.ai_client import ask_marketing

        step_instructions = {
            1: (
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞—á–∞–ª –≥–∞–π–¥ –ø–æ —Ç–µ–º–µ ¬´{topic}¬ª 24 —á–∞—Å–∞ –Ω–∞–∑–∞–¥.\n"
                "–ù–∞–ø–∏—à–∏ –ö–û–†–û–¢–ö–û–ï (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –¥—Ä—É–∂–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:\n"
                "1. –ü–æ–∏–Ω—Ç–µ—Ä–µ—Å—É–π—Å—è, —É–¥–∞–ª–æ—Å—å –ª–∏ –Ω–∞—á–∞—Ç—å –∏–∑—É—á–µ–Ω–∏–µ\n"
                "2. –ó–∞–¥–∞–π –ö–û–ù–ö–†–ï–¢–ù–´–ô –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ —Ç–µ–º–µ –≥–∞–π–¥–∞\n"
                "   (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–í–æ–∑–Ω–∏–∫–ª–∏ –ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –≤ e-gov?')\n"
                "3. –ü—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–º–æ—â—å –æ—Ç SOLIS Partners"
            ),
            2: (
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞—á–∞–ª –≥–∞–π–¥ –ø–æ —Ç–µ–º–µ ¬´{topic}¬ª 3 –¥–Ω—è –Ω–∞–∑–∞–¥, "
                "–Ω–æ –Ω–µ –ø—Ä–æ—à—ë–ª –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.\n"
                "–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è):\n"
                "1. –†–∞—Å—Å–∫–∞–∂–∏ –æ –†–ï–ê–õ–¨–ù–û–ú –∫–µ–π—Å–µ –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ (–ø—Ä–∏–¥—É–º–∞–π —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–π)\n"
                "2. –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –∑–∞—Å—Ç–∞–≤–∏—Ç –∑–∞–¥—É–º–∞—Ç—å—Å—è –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —é—Ä–∏—Å—Ç–∞\n"
                "3. –£–ø–æ–º—è–Ω–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é —á–µ—Ä–µ–∑ /consult"
            ),
            3: (
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞—á–∞–ª –≥–∞–π–¥ –ø–æ —Ç–µ–º–µ ¬´{topic}¬ª –Ω–µ–¥–µ–ª—é –Ω–∞–∑–∞–¥, "
                "–Ω–µ –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞–ª—Å—è –∏ –º–æ–∂–µ—Ç —É–π—Ç–∏.\n"
                "–ù–∞–ø–∏—à–∏ –ú–û–¢–ò–í–ò–†–£–Æ–©–ï–ï —Å–æ–æ–±—â–µ–Ω–∏–µ (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è):\n"
                "1. –ü—Ä–µ–¥–ª–æ–∂–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é 15-–º–∏–Ω—É—Ç–Ω—É—é –º–∏–Ω–∏-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é\n"
                "2. –û–±—ä—è—Å–Ω–∏, —á–µ–º —ç—Ç–æ –ø–æ–ª–µ–∑–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –¥–ª—è –µ–≥–æ —Ç–µ–º—ã\n"
                "3. –°–æ–∑–¥–∞–π –º—è–≥–∫—É—é —Å—Ä–æ—á–Ω–æ—Å—Ç—å ('–Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ')\n"
                "4. –î–∞–π —Å—Å—ã–ª–∫—É –Ω–∞ @SOLISlegal"
            ),
        }

        instruction = step_instructions.get(step, step_instructions[1])

        result = await ask_marketing(
            prompt=instruction,
            max_tokens=256,
            temperature=0.7,
        )
        return result.strip()

    except Exception as e:
        logger.warning("AI followup generation failed: %s", e)
        return None


async def send_followup_message(
    user_id: int,
    guide_id: str,
    step: int,
    *,
    bot: Bot,
    google: GoogleSheetsClient,
    cache: TTLCache,
) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç follow-up —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

    Args:
        user_id: Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        guide_id: ID –≥–∞–π–¥–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–∫–∞—á–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
        step: –®–∞–≥ —Å–µ—Ä–∏–∏ (1, 2 –∏–ª–∏ 3).
        bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.
        google: –ö–ª–∏–µ–Ω—Ç Google Sheets.
        cache: TTL-–∫–µ—à.
    """
    try:
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º: –º–æ–∂–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –ø—Ä–æ—à—ë–ª –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é?
        consult_log = await google.get_consult_log(limit=50)
        user_consulted = any(
            str(row.get("user_id", row.get("User ID", ""))) == str(user_id)
            for row in consult_log
        )

        if user_consulted and step == 1:
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–æ–≤–ª–µ—á—ë–Ω ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª—ë–≥–∫–∏–π follow-up
            text = (
                "üëã –†–∞–¥—ã, —á—Ç–æ –≤—ã —É–∂–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –Ω–∞—à–µ–π AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π!\n\n"
                "–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –Ω–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –ø–∏—à–∏—Ç–µ /consult, "
                "–∞ –¥–ª—è —É–≥–ª—É–±–ª—ë–Ω–Ω–æ–π –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ @SOLISlegal."
            )
            await bot.send_message(chat_id=user_id, text=text)
            logger.info("Follow-up (consulted user): user_id=%s, step=%d", user_id, step)
            return

        # 2. –ü—Ä–æ–±—É–µ–º AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
        ai_text = await _generate_personalized_question(guide_id, step)

        # 3. –ï—Å–ª–∏ AI –Ω–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è ‚Äî fallback –∏–∑ Sheets –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π
        if not ai_text:
            followup_texts = await cache.get_or_fetch(
                "followup_series",
                google.get_followup_series,
            )

            specific_key = f"{guide_id}_step_{step}"
            generic_key = f"step_{step}"

            ai_text = (
                followup_texts.get(specific_key)
                or followup_texts.get(generic_key)
                or FALLBACK_FOLLOWUP.get(step, "")
            )

        if not ai_text:
            logger.warning("–¢–µ–∫—Å—Ç follow-up –Ω–µ –Ω–∞–π–¥–µ–Ω: step=%d, guide=%s", step, guide_id)
            return

        # 4. –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤–æ–≤–ª–µ—á–µ–Ω–∏—è
        buttons = [
            [InlineKeyboardButton(
                text="ü§ñ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å AI-—é—Ä–∏—Å—Ç—É",
                callback_data="start_consult",
            )],
            [InlineKeyboardButton(
                text="üìö –î—Ä—É–≥–∏–µ –≥–∞–π–¥—ã",
                callback_data="show_all_guides",
            )],
        ]
        if step >= 2:
            buttons.insert(0, [InlineKeyboardButton(
                text="üìû –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é",
                url="https://t.me/SOLISlegal",
            )])

        keyboard = InlineKeyboardMarkup(inline_keyboard=buttons)

        try:
            await bot.send_message(
                chat_id=user_id,
                text=ai_text,
                reply_markup=keyboard,
            )
        except Exception:
            await bot.send_message(
                chat_id=user_id,
                text=ai_text,
                reply_markup=keyboard,
                parse_mode=None,
            )

        logger.info(
            "Follow-up –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: user_id=%s, guide=%s, step=%d (AI-personalized)",
            user_id, guide_id, step,
        )
    except Exception as e:
        logger.error(
            "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ follow-up: user_id=%s, step=%d, error=%s",
            user_id, step, e,
        )
